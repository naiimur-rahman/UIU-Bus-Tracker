<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UIU Bus Tracker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316', 
                            600: '#ea580c',
                            900: '#7c2d12',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: '1', boxShadow: '0 0 0 0px rgba(34, 197, 94, 0.7)' },
                            '50%': { opacity: '.5', boxShadow: '0 0 0 15px rgba(34, 197, 94, 0)' },
                        }
                    }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
        }
        .dark-map-tiles {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }
        .view-section {
            position: absolute;
            inset: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            visibility: hidden;
            overflow-y: hidden;
            z-index: 0;
            display: flex;
            flex-direction: column;
        }
        .view-active {
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: scale(1) !important;
            z-index: 100 !important;
            visibility: visible !important;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes drive {
            0% { transform: translateY(0) rotate(3deg); }
            50% { transform: translateY(-6px) rotate(0deg); }
            100% { transform: translateY(0) rotate(3deg); }
        }
        .animate-drive { animation: drive 1.5s ease-in-out infinite; }
        .pulse-ring::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; right: 0;
            border-radius: 50%; border: 2px solid white; animation: ring 1.5s infinite;
        }
        @keyframes ring { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .leaflet-div-icon { background: transparent; border: none; }
        body { overscroll-behavior: none; }
        #view-profile { background-color: rgb(248 250 252) !important; }
        .dark #view-profile { background-color: rgb(15 23 42) !important; }
        

        /* Custom Leaflet Controls */
        .leaflet-bar { border: none !important; box-shadow: none !important; }
        .leaflet-bar a {
            border-radius: 50% !important;
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            background-color: white !important;
            color: #64748b !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            margin-bottom: 8px !important;
            border-bottom: none !important;
            transition: all 0.2s ease;
        }
        .dark .leaflet-bar a {
            background-color: #1e293b !important;
            color: #cbd5e1 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3) !important;
        }
        .leaflet-bar a:hover {
            background-color: #f8fafc !important;
            transform: scale(1.05);
            color: #f97316 !important;
        }
        .dark .leaflet-bar a:hover {
            background-color: #334155 !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-gray-100 font-sans h-[100dvh] w-screen overflow-hidden transition-colors duration-300 relative selection:bg-brand-500 selection:text-white dot-pattern">
<div id="welcome-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md transition-opacity duration-500">
    <div class="glass w-full max-w-md rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] animate-float" style="animation-duration: 10s;">
        
        <div class="p-5 border-b border-slate-200/50 dark:border-slate-700/50 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-bullhorn text-sm"></i>
                </div>
                <h3 class="font-bold text-lg text-slate-800 dark:text-white">Notice Board</h3>
            </div>
            <button onclick="closeWelcomeModal()" class="w-8 h-8 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition-colors">
                <i class="fas fa-times text-slate-500"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto text-sm leading-relaxed text-slate-600 dark:text-slate-300 space-y-4">
            <p class="font-bold text-brand-600 dark:text-brand-400">Welcome to UIU Bus Tracker v2.0!</p>
            
            <p>
                This application is designed to help UIU students and transport staff coordinate bus locations in real-time.
            </p>

            <hr class="border-slate-200 dark:border-slate-700">

            <h4 class="font-bold text-slate-800 dark:text-white">‚ú® New Features:</h4>
            <ul class="list-disc pl-5 space-y-1">
                <li>Real-time GPS Tracking with high accuracy.</li>
                <li>Live Speedometer and Distance calculation.</li>
                <li>Dark Mode support for night trips.</li>
                <li>"Wake Lock" to keep screen on for drivers.</li>
            </ul>

            <h4 class="font-bold text-slate-800 dark:text-white mt-4">‚ö†Ô∏è Important Note:</h4>
            <p>
                Please ensure you have <strong>Location Services (GPS)</strong> enabled. Do not close the browser tab while driving, or the broadcast will stop.<p>**use Android Application if you are a Driver. <3</p> 
            </p>
            
            <p class="italic text-xs opacity-70 mt-4">
                "Development is a journey, not a destination.<br>Thank you for being part of our testing phase." <br>
                - Naimur Rahman
            </p>
            
            <div class="h-10"></div> 
        </div>

        <div class="p-4 bg-slate-50/80 dark:bg-slate-900/80 border-t border-slate-200/50 dark:border-slate-700/50 backdrop-blur-sm">
            <button onclick="closeWelcomeModal()" class="w-full py-3.5 bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-xl shadow-lg shadow-orange-500/20 active:scale-95 transition-all">
                I Understand, Let's Go!
            </button>
        </div>
    </div>
</div>
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-20 -left-20 w-64 h-64 bg-brand-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
        <div class="absolute top-1/2 -right-20 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 2s"></div>
        <div class="absolute -bottom-20 left-1/3 w-80 h-80 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 4s"></div>
    </div>

    <div id="global-controls" class="z-[500] relative transition-opacity duration-300 pointer-events-none">
        <button onclick="app.toggleTheme()" class="fixed top-4 right-4 w-10 h-10 rounded-full glass flex items-center justify-center text-slate-600 dark:text-yellow-400 shadow-lg hover:scale-110 transition-transform cursor-pointer pointer-events-auto">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
        </button>
    </div>

    <div id="view-landing" class="view-section view-active p-4 h-full z-10 flex flex-col justify-between">
        <div class="flex-grow flex flex-col items-center justify-center w-full max-w-sm mx-auto">
            <div class="text-center mb-4"> 
                <div class="w-20 h-20 bg-gradient-to-tr from-brand-500 to-orange-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-orange-500/30 transform rotate-3 animate-drive">
                    <i class="fas fa-bus text-4xl text-white"></i>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight mb-1">
                    <span class="text-slate-800 dark:text-white">UIU</span>
                    <span class="text-brand-500">Bus Tracker</span>
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Next Gen Campus Transport</p>
            </div>

            <div class="grid gap-3 w-full"> 
                <button onclick="app.setRole('student')" class="glass group relative overflow-hidden p-5 rounded-2xl text-left hover:border-brand-500 transition-all duration-300">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-500 transform scale-y-0 group-hover:scale-y-100 transition-transform origin-top"></div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-1">Bus Kothay</h3>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Real-time tracking</p>
                        </div>
                        <div class="w-10 h-10 bg-blue-50 dark:bg-slate-700 rounded-full flex items-center justify-center text-blue-500 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                            <i class="fas fa-map-location-dot text-lg"></i>
                        </div>
                    </div>
                </button>

                <button onclick="app.setRole('driver-select')" class="glass group relative overflow-hidden p-5 rounded-2xl text-left hover:border-brand-500 transition-all duration-300">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-500 transform scale-y-0 group-hover:scale-y-100 transition-transform origin-top"></div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-1">Start a Trip</h3>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Share location with others</p>
                        </div>
                        <div class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-slate-600 dark:text-slate-300 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                            <i class="fas fa-id-card text-lg"></i>
                        </div>
                    </div>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 w-full mt-4"> 
                <a href="https://naiimur-rahman.github.io/UIU-Incognito-Chat/" target="_blank" class="glass p-4 rounded-2xl hover:scale-[1.02] transition-transform text-left block border-l-4 border-l-purple-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-500">
                            <i class="fas fa-comments text-sm"></i>
                        </div>
                        <h4 class="font-bold text-xs">Incognito Chat</h4>
                    </div>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight">Connect anonymously.</p>
                </a>

                <a href="https://naiimur-rahman.github.io/UIU-CGPA-Calculator/" target="_blank" class="glass p-4 rounded-2xl hover:scale-[1.02] transition-transform text-left block border-l-4 border-l-green-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-500">
                            <i class="fas fa-calculator text-sm"></i>
                        </div>
                        <h4 class="font-bold text-xs">CGPA Calculator</h4>
                    </div>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight">Calculate CGPA and more.</p>
                </a>
            </div>
        </div>
        
        <div class="pt-2 pb-4 text-center px-4 w-full shrink-0 z-50">
            <p class="text-xs text-slate-400 dark:text-slate-500 font-medium">
                Developed by <a href="https://www.facebook.com/naiimurr/" target="_blank" class="text-brand-500 hover:underline">Naimur Rahman</a> (CSE 242) for UIU‚ù§Ô∏è
            </p>
        </div>
    </div>

    <div id="view-driver-select" class="view-section flex flex-col h-full z-10 p-6 bg-slate-50 dark:bg-slate-900">
        <div class="flex items-center mb-8 mt-4 shrink-0">
            <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-brand-500 transition-colors mr-4">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="text-2xl font-bold">Select Route</h2>
        </div>

        <div id="route-sub-select" class="hidden absolute inset-0 bg-white/95 dark:bg-slate-900/95 z-20 flex flex-col items-center justify-center p-6 text-center backdrop-blur-md">
            <h3 class="text-2xl font-bold mb-6">Which Direction?</h3>

            <div class="w-full max-w-xs mb-4 text-left">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Your Name</label>
                <input type="text" id="driver-username-input" placeholder="Captain (Optional)" maxlength="15"
                       class="w-full glass bg-white/50 dark:bg-slate-800/50 p-4 rounded-xl outline-none focus:ring-2 ring-brand-500 transition-all font-bold text-slate-700 dark:text-white placeholder:font-normal">
            </div>

            <button onclick="app.confirmRoute('To UIU')" class="w-full max-w-xs glass p-6 rounded-xl mb-4 hover:bg-brand-50 transition-colors border-l-4 border-l-green-500 text-left">
                <div class="font-bold text-lg">Going to Campus</div>
                <div class="text-xs text-slate-500">From Destination &rarr; UIU</div>
            </button>
            <button onclick="app.confirmRoute('From UIU')" class="w-full max-w-xs glass p-6 rounded-xl hover:bg-brand-50 transition-colors border-l-4 border-l-blue-500 text-left">
                <div class="font-bold text-lg">Leaving Campus</div>
                <div class="text-xs text-slate-500">UIU &rarr; To Destination</div>
            </button>
            <button onclick="document.getElementById('route-sub-select').classList.add('hidden')" class="mt-8 text-slate-400 hover:text-slate-600">Cancel</button>
        </div>

        <div class="grid grid-cols-2 gap-4 overflow-y-auto pb-4">
            <button onclick="app.selectRoute('Kuril', 'K')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-road text-3xl text-blue-500 mb-3"></i>
                <span class="font-bold">Kuril</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Notun Bazar', 'N')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-shop text-3xl text-green-500 mb-3"></i>
                <span class="font-bold">Notun Bazar</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Aftab Nagar', 'A')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-building text-3xl text-purple-500 mb-3"></i>
                <span class="font-bold">Aftab Nagar</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Transport', 'R')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-bus-alt text-3xl text-orange-500 mb-3"></i>
                <span class="font-bold">Transport</span>
                <span class="text-xs text-slate-400 mt-1">Routes 1-5...</span>
            </button>
        </div>

        <div id="selection-loader" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="font-bold animate-pulse">Syncing & Assigning ID...</p>
        </div>
    </div>

    <div id="view-driver-dashboard" class="view-section flex flex-col h-full bg-slate-50 dark:bg-slate-900 z-10">
        <div class="absolute top-0 left-0 right-0 p-4 z-30 flex justify-between items-start pointer-events-none">
            <div class="pointer-events-auto">
                 <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass bg-slate-900/50 text-white flex items-center justify-center hover:scale-110 transition-transform">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
            <div class="glass bg-slate-900/80 text-white px-4 py-2 rounded-xl text-right backdrop-blur-md">
                 <div class="flex items-center justify-end gap-2 mb-1">
                    <span id="driver-connection-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span id="driver-connection-text" class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Offline</span>
                </div>
                <div class="text-xs text-slate-400">ID: <span id="driver-assigned-id" class="text-brand-500 font-mono font-bold">...</span></div>
                <div id="driver-display-username-container" class="hidden text-[10px] text-slate-400 mt-0.5 text-right font-medium">
                    <span id="driver-display-username" class="text-white"></span>
                </div>
                <div id="wakelock-status" class="text-[8px] text-slate-500 mt-0.5">
                    <i class="fas fa-mobile-alt"></i> Wake Lock: <span id="wakelock-text">Off</span>
                </div>
            </div>
        </div>

        <div class="h-[60%] w-full relative z-0">
            <div id="driver-map" class="w-full h-full bg-slate-200 dark:bg-slate-800"></div>
            <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-slate-50 dark:from-slate-900 to-transparent pointer-events-none z-[400]"></div>
        </div>

        <div class="flex-grow flex flex-col items-center justify-start p-6 -mt-12 relative z-20 overflow-y-auto">
            <div class="glass w-full max-w-sm rounded-3xl p-6 shadow-xl text-center backdrop-blur-xl border border-white/20">
                <div class="flex items-center justify-between mb-6">
                      <div class="text-left">
                        <h2 id="broadcast-status-title" class="text-xl font-bold">Ready to Drive?</h2>
                        <p id="broadcast-status-desc" class="text-slate-500 text-xs">Start trip to broadcast</p>
                      </div>
                      <div id="broadcast-ring" class="w-12 h-12 rounded-full border-2 border-slate-200 dark:border-slate-600 flex items-center justify-center relative">
                        <div class="absolute inset-0 rounded-full animate-pulse-glow opacity-0 transition-opacity" id="broadcast-glow"></div>
                        <i id="broadcast-icon" class="fas fa-location-arrow text-slate-300 dark:text-slate-600 transition-colors"></i>
                    </div>
                </div>

                <button id="broadcast-btn" onclick="app.toggleBroadcast()" class="w-full bg-gradient-to-b from-brand-500 to-brand-600 hover:from-brand-400 hover:to-brand-500 text-white font-bold py-5 rounded-2xl shadow-[0_10px_20px_-5px_rgba(249,115,22,0.4),0_4px_6px_-2px_rgba(0,0,0,0.1),inset_0_2px_0_rgba(255,255,255,0.2)] active:shadow-[inset_0_4px_8px_rgba(0,0,0,0.2)] active:translate-y-[2px] transition-all duration-150 mb-4 relative z-50 uppercase tracking-widest text-sm border-b-4 border-brand-900/20 active:border-b-0">
                    START TRIP
                </button>
            </div>

            <div class="grid grid-cols-3 gap-3 w-full max-w-sm mt-6 px-2">
                <div class="glass p-3 rounded-xl text-center flex flex-col items-center justify-center border border-slate-200/50 dark:border-slate-700/50 bg-slate-100/30 dark:bg-slate-800/30 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                    <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest mb-1">Speed</p>
                    <p id="val-speed" class="text-xl font-mono font-bold text-slate-700 dark:text-slate-100 tracking-tighter">0<span class="text-[10px] ml-0.5 text-slate-400 font-sans">km/h</span></p>
                </div>
                <div class="glass p-3 rounded-xl text-center flex flex-col items-center justify-center border border-slate-200/50 dark:border-slate-700/50 bg-slate-100/30 dark:bg-slate-800/30 relative overflow-hidden">
                      <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                    <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest mb-1">GPS</p>
                    <p id="val-accuracy" class="text-xl font-mono font-bold text-slate-700 dark:text-slate-100 tracking-tighter">--</p>
                </div>
                <div class="glass p-3 rounded-xl text-center flex flex-col items-center justify-center border border-slate-200/50 dark:border-slate-700/50 bg-slate-100/30 dark:bg-slate-800/30 relative overflow-hidden">
                      <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent pointer-events-none"></div>
                    <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest mb-1">Time</p>
                    <p id="val-uptime" class="text-xl font-mono font-bold text-slate-700 dark:text-slate-100 tracking-tighter">00:00</p>
                </div>
            </div>
        </div>

        <div id="trip-summary-modal" class="absolute inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
             <div class="w-32 h-32 bg-gradient-to-tr from-brand-500 to-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-[0_0_50px_rgba(249,115,22,0.5)]">
                 <i class="fas fa-heart text-6xl text-white"></i>
             </div>
             <h2 class="text-4xl font-black text-white mb-2 text-center">Thank You!</h2>
             <p class="text-slate-400 mb-8 text-center px-4 max-w-xs">Thanks for your Contribution.<br>It means a lot for us.</p>

             <button onclick="app.closeSummary()" class="mt-4 px-8 py-3 bg-white text-brand-600 font-bold rounded-full hover:scale-105 transition-transform shadow-lg shadow-white/20">
                 Close
             </button>
        </div>
    </div>

    <div id="view-student" class="view-section flex flex-col h-full z-10">
        <div class="absolute top-4 left-4 right-16 z-[400]">
            <div class="glass rounded-full p-2 pl-4 pr-2 flex justify-between items-center shadow-lg">
                <div class="flex items-center gap-3">
                    <button onclick="app.goHome()" class="w-8 h-8 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-brand-500 hover:text-white transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-sm leading-tight">Live Map</h2>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500 dark:text-slate-400">
                            <span class="flex items-center gap-1"><i class="fas fa-users"></i> <span id="count-users">0</span></span>
                            <span class="flex items-center gap-1"><i class="fas fa-bus"></i> <span id="count-buses">0</span></span>
                        </div>
                    </div>
                </div>
                <div id="student-status" class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] font-bold text-slate-500 flex items-center gap-2">
                    <div class="w-2 h-2 bg-slate-400 rounded-full"></div> Connect
                </div>
            </div>
        </div>

        <div class="flex-grow relative bg-slate-200 dark:bg-slate-900 overflow-hidden">
            <div id="map" class="h-full w-full outline-none z-0"></div>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 relative transition-transform duration-300 transform translate-y-0" id="bottom-sheet">
            <div class="w-full flex justify-center pt-4 pb-2 cursor-pointer" onclick="app.toggleBottomSheet()">
                <div class="w-16 h-1.5 bg-slate-300/50 dark:bg-slate-600/50 rounded-full backdrop-blur-sm"></div>
            </div>
            <div class="p-4 pb-8 max-h-[40vh] overflow-y-auto">
                <h3 class="font-bold mb-4 text-sm text-slate-500 uppercase tracking-wide">Active Transport</h3>
                <div id="bus-list" class="space-y-2">
                    <div class="text-center py-8 text-slate-400 text-sm">
                        <i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>
                        Searching for buses...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script type="module">
    /** * UIU BUS TRACKER V2.0 - FINAL STABLE BUILD
     * Features: Android Native Bridge, WakeLock, MQTT Optimization, Dynamic UI
     */

    // --- Global Helper for Modal ---
    window.closeWelcomeModal = function() {
        const modal = document.getElementById('welcome-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.style.pointerEvents = 'none';
            setTimeout(() => { modal.style.display = 'none'; }, 500);
        }
    };

    // --- Configuration ---
    const CONFIG = {
        mqtt: {
            protocol: 'wss',
            host: '09872002dac9410e9af391b1a7066483.s1.eu.hivemq.cloud',
            port: 8884,
            path: '/mqtt',
            username: 'naimur',
            password: 'Sohan786@',
            clientId: (() => {
                let id = localStorage.getItem('mqtt_client_id');
                if (!id) {
                    id = 'uiu-' + Math.random().toString(16).substr(2, 8);
                    localStorage.setItem('mqtt_client_id', id);
                }
                return id;
            })()
        },
        topics: {
            location: 'uiu/bus/location',
            presence: 'uiu/presence'
        },
        uiuCoords: [23.79790, 90.44970], 
        presenceInterval: 15000,
        minAccuracy: 50
    };

    const BUS_STYLES = {
        'K': 'bg-blue-500',   // Kuril
        'N': 'bg-green-500',  // Notun Bazar
        'A': 'bg-purple-500', // Aftab Nagar
        'default': 'bg-orange-500',
        'to_uiu': 'bg-green-600',
        'from_uiu': 'bg-red-600'
    };

    /** GLOBAL STATE */
    const state = {
        client: null,
        isConnected: false,
        connectionDebounce: null, 
        role: null,
        driverId: null,
        driverRoute: null,
        driverDestination: null,
        driverDirection: null,
        driverUsername: null,
        isBroadcasting: false,
        watchId: null,
        wakeLock: null,
        activeBuses: {},
        activeUsers: new Map(),
        map: null,
        driverMap: null,
        driverMarker: null,
        markers: {},
        circles: {}, 
        lastSentTime: 0,
        sessionDistance: 0,
        lastLat: null,
        lastLng: null,
        tripStartTime: null,
        uptimeInterval: null,
        currentSmoothedSpeed: 0
    };

    /** * ANDROID INTERFACE BRIDGE 
     * Receives location data from the Java Foreground Service
     */
    window.handleAndroidLocation = function(lat, lng, accuracy, speed) {
        // Ensure types are numbers (Java might send strings)
        const nLat = parseFloat(lat);
        const nLng = parseFloat(lng);
        const nAcc = parseFloat(accuracy);
        const nSpeed = parseFloat(speed);

        if (window.app && window.app.handleNativeLocationUpdate) {
            window.app.handleNativeLocationUpdate(nLat, nLng, nAcc, nSpeed);
        }
    };

    /** MAIN APP CONTROLLER */
    const app = {
        init: () => {
            app.loadTheme();
            app.connectMqtt();
            
            // Check LocalStorage for active session
            const savedDriverId = localStorage.getItem('active_driver_id');
            const savedRoute = localStorage.getItem('active_driver_route');
            
            if (savedDriverId && savedRoute) {
                state.driverId = savedDriverId;
                state.driverRoute = savedRoute;
                state.driverDestination = localStorage.getItem('active_driver_dest');
                state.driverDirection = localStorage.getItem('active_driver_dir');
                state.driverUsername = localStorage.getItem('active_driver_username');
                
                app.setRole('driver-dashboard');
                document.getElementById('driver-assigned-id').innerText = `${state.driverRoute} [${state.driverId}]`;

                if (state.driverUsername) {
                    document.getElementById('driver-display-username-container').classList.remove('hidden');
                    document.getElementById('driver-display-username').innerText = state.driverUsername;
                }
                app.switchView('view-driver-dashboard');
                app.initDriverMap();
            }

            setInterval(app.sendHeartbeat, CONFIG.presenceInterval);
            setInterval(app.cleanupStaleUsers, 10000);
        },

        // --- Theme & Utils ---
        escapeHtml: (text) => {
            if (!text) return text;
            return String(text)
                .replace(/&/g, "&amp;").replace(/</g, "&lt;")
                .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        },

        toggleTheme: () => {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
            app.updateMapStyle();
        },

        loadTheme: () => {
            const theme = localStorage.getItem('theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        },

        switchView: (viewId) => {
            // Hide Overlays
            document.getElementById('selection-loader').classList.add('hidden');
            document.getElementById('route-sub-select').classList.add('hidden');

            const views = document.querySelectorAll('.view-section');
            views.forEach(el => {
                el.classList.remove('view-active');
                el.style.opacity = '0';
                el.style.pointerEvents = 'none';
                el.style.zIndex = '0';
            });

            const target = document.getElementById(viewId);
            if (target) {
                target.classList.add('view-active');
                target.style.opacity = '1';
                target.style.pointerEvents = 'auto';
                target.style.zIndex = '100';
                target.style.visibility = 'visible';
            }

            const globalControls = document.getElementById('global-controls');
            if (globalControls) {
                if (viewId === 'view-landing') {
                    globalControls.classList.remove('opacity-0', 'pointer-events-none', 'invisible');
                } else {
                    globalControls.classList.add('opacity-0', 'pointer-events-none', 'invisible');
                }
            }
        },

        setRole: (role) => {
            state.role = role;
            if (role === 'student') {
                app.switchView('view-student');
                app.initMap();
            } else if (role === 'driver-select') {
                app.switchView('view-driver-select');
            } else if (role === 'driver-dashboard') {
                app.switchView('view-driver-dashboard');
            }
        },

        goHome: async () => {
            if (state.isBroadcasting) {
                const confirmExit = confirm("Stop broadcasting and exit?");
                if (!confirmExit) return;
                await app.stopBroadcast();
            }

            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }

            state.driverId = null;
            state.driverRoute = null;
            state.role = null;
            state.isBroadcasting = false;
            state.activeBuses = {};

            if (state.driverMap) {
                try { state.driverMap.remove(); } catch (e) {}
                state.driverMap = null;
            }
            state.driverMarker = null;

            localStorage.removeItem('active_driver_id');
            localStorage.removeItem('active_driver_route');
            localStorage.removeItem('active_driver_dest');
            localStorage.removeItem('active_driver_dir');
            localStorage.removeItem('active_driver_username');
            
            app.switchView('view-landing');
        },

        // --- Wake Lock ---
        requestWakeLock: async () => {
            if ('wakeLock' in navigator) {
                try {
                    state.wakeLock = await navigator.wakeLock.request('screen');
                    const el = document.getElementById('wakelock-text');
                    if(el) {
                        el.innerText = "Active";
                        el.className = "text-green-500 font-bold";
                    }
                    
                    state.wakeLock.addEventListener('release', () => {
                        const el = document.getElementById('wakelock-text');
                        if(el) {
                            el.innerText = "Inactive";
                            el.className = "";
                        }
                    });
                } catch (err) {
                    console.log("Wake Lock Error: " + err.name);
                }
            }
        },

        releaseWakeLock: () => {
            if (state.wakeLock) {
                state.wakeLock.release();
                state.wakeLock = null;
            }
        },

        // --- MQTT Logic ---
        connectMqtt: () => {
            const connectUrl = `wss://${CONFIG.mqtt.host}:${CONFIG.mqtt.port}/mqtt`;
            state.client = mqtt.connect(connectUrl, {
                username: CONFIG.mqtt.username,
                password: CONFIG.mqtt.password,
                clientId: CONFIG.mqtt.clientId,
                clean: true
            });

            state.client.on('connect', () => {
                if (state.connectionDebounce) clearTimeout(state.connectionDebounce);
                state.isConnected = true;
                app.updateConnectionStatus('connected');
                state.client.subscribe(CONFIG.topics.location);
                state.client.subscribe(CONFIG.topics.presence);
                app.sendHeartbeat();
            });

            state.client.on('message', (topic, message) => {
                const msgString = message.toString();
                if (!msgString) return;
                try {
                    const data = JSON.parse(msgString);
                    if (topic === CONFIG.topics.location) {
                        app.handleLocationUpdate(data);
                    } else if (topic === CONFIG.topics.presence) {
                        app.handlePresenceUpdate(data);
                    }
                } catch (e) { console.error("Msg Parse Error:", e); }
            });

            state.client.on('error', (err) => {
                console.error("MQTT Error", err);
                state.isConnected = false;
                app.updateConnectionStatus('error');
            });
            
            state.client.on('close', () => {
                state.isConnected = false;
                app.updateConnectionStatus('offline');
            });
        },

        updateConnectionStatus: (status) => {
            const dot = document.getElementById('driver-connection-dot');
            const text = document.getElementById('driver-connection-text');
            const studentStatus = document.getElementById('student-status');

            if (status === 'connected') {
                if (dot) dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]";
                if (text) text.innerText = "ONLINE";
                if (studentStatus) {
                    studentStatus.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Live';
                    studentStatus.classList.add('text-green-600', 'bg-green-100');
                }
            } else {
                if (dot) dot.className = "w-2 h-2 rounded-full bg-red-500";
                if (text) text.innerText = "OFFLINE";
                if (studentStatus) {
                     studentStatus.innerHTML = '<div class="w-2 h-2 bg-slate-400 rounded-full"></div> Connect';
                }
            }
        },

        sendHeartbeat: () => {
            if (state.client && state.isConnected) {
                state.client.publish(CONFIG.topics.presence, JSON.stringify({
                    id: CONFIG.mqtt.clientId,
                    ts: Date.now(),
                    role: state.role || 'viewer'
                }));
            }
        },

        handlePresenceUpdate: (data) => {
            state.activeUsers.set(data.id, data.ts);
            app.updateUserCount();
        },

        cleanupStaleUsers: () => {
            const now = Date.now();
            // Cleanup Users
            for (const [id, ts] of state.activeUsers) {
                if (now - ts > 45000) state.activeUsers.delete(id);
            }
            app.updateUserCount();
            
            // Cleanup Buses
            for (const id in state.activeBuses) {
                if (now - state.activeBuses[id].ts > 60000) { 
                    delete state.activeBuses[id];
                    app.removeBusMarker(id);
                }
            }
            app.updateBusList();
        },

        updateUserCount: () => {
            const el = document.getElementById('count-users');
            if (el) el.innerText = state.activeUsers.size;
        },

        handleLocationUpdate: (data) => {
            if (data.status === 'offline') {
                delete state.activeBuses[data.id];
                app.removeBusMarker(data.id);
                app.updateBusList();
                return;
            }
            // Ignore own data to prevent loops
            if (state.isBroadcasting && data.id === state.driverId) return;

            state.activeBuses[data.id] = data;
            if (state.role === 'student') {
                app.updateBusMarker(data);
                app.updateBusList();
            }
        },

        // --- Route Selection ---
        selectRoute: (name, prefix) => {
            state.tempRouteName = name;
            state.tempRoutePrefix = prefix;
            const savedName = localStorage.getItem('saved_username');
            if (savedName) document.getElementById('driver-username-input').value = savedName;
            document.getElementById('route-sub-select').classList.remove('hidden');
        },

        confirmRoute: (direction) => {
            const name = state.tempRouteName;
            const prefix = state.tempRoutePrefix;
            const fullRouteName = `${name} (${direction})`;
            const username = document.getElementById('driver-username-input').value.trim() || null;

            document.getElementById('route-sub-select').classList.add('hidden');
            document.getElementById('selection-loader').classList.remove('hidden');

            // Simulate ID assignment delay
            setTimeout(() => {
                const assignedId = app.assignNextId(prefix);
                
                state.driverRoute = fullRouteName;
                state.driverId = assignedId;
                state.driverDestination = name;
                state.driverDirection = direction;
                state.driverUsername = username;

                // Save session
                localStorage.setItem('active_driver_id', assignedId);
                localStorage.setItem('active_driver_route', fullRouteName);
                localStorage.setItem('active_driver_dest', name);
                localStorage.setItem('active_driver_dir', direction);
                if (username) localStorage.setItem('active_driver_username', username);

                document.getElementById('driver-assigned-id').innerText = fullRouteName + ' [' + assignedId + ']';
                
                if (username) {
                    document.getElementById('driver-display-username-container').classList.remove('hidden');
                    document.getElementById('driver-display-username').innerText = username;
                }

                document.getElementById('selection-loader').classList.add('hidden');
                app.switchView('view-driver-dashboard');
                app.initDriverMap();
            }, 1000);
        },

        assignNextId: (prefix) => {
            const activeIds = Object.keys(state.activeBuses)
                .filter(id => id.startsWith(prefix))
                .map(id => parseInt(id.replace(prefix, '')))
                .filter(num => !isNaN(num)).sort((a, b) => a - b);
            
            let nextNum = 1;
            for (const num of activeIds) {
                if (num === nextNum) nextNum++;
                else if (num > nextNum) break;
            }
            return prefix + nextNum;
        },

        calculateDistance: (lat1, lon1, lat2, lon2) => {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        },

        // --- Driver Map ---
        initDriverMap: () => {
            if (state.driverMap) state.driverMap.remove();
            
            const COORDS = {
                'UIU': CONFIG.uiuCoords, 
                'Kuril': [23.822339, 90.420163],
                'Notun Bazar': [23.797881, 90.424652],
                'Aftab Nagar': [23.767860, 90.425833],
                'Transport': CONFIG.uiuCoords 
            };

            let start = (state.driverDirection === 'From UIU') ? COORDS['UIU'] : (COORDS[state.driverDestination] || COORDS['Transport']);
            
            setTimeout(() => {
                if (!document.getElementById('driver-map')) return; 
                state.driverMap = L.map('driver-map', { zoomControl: false }).setView(start, 13);
                
                const isDark = document.documentElement.classList.contains('dark');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OSM',
                    className: isDark ? 'dark-map-tiles' : ''
                }).addTo(state.driverMap);

                const icon = L.divIcon({ 
                    className: '', 
                    html: '<div class="bg-blue-600 w-6 h-6 rounded-full border-2 border-white shadow-lg flex items-center justify-center relative"><div class="w-2 h-2 bg-white rounded-full"></div></div>', 
                    iconSize: [24, 24] 
                });
                state.driverMarker = L.marker(start, {icon: icon}).addTo(state.driverMap);
            }, 200);
        },

        // --- BROADCASTING (Web vs Android) ---
        toggleBroadcast: () => {
            if (state.isBroadcasting) app.stopBroadcast();
            else app.startBroadcast();
        },

        startBroadcast: () => {
            // 1. Update State & UI First
            state.isBroadcasting = true;
            app.updateBroadcastUI(true);
            app.requestWakeLock();

            // Start Uptime Timer (Visual only)
            state.tripStartTime = Date.now();
            if (state.uptimeInterval) clearInterval(state.uptimeInterval);
            state.uptimeInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - state.tripStartTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                const el = document.getElementById('val-uptime');
                if(el) el.innerText = `${m}:${s}`;
            }, 1000);

            // 2. CHECK FOR ANDROID NATIVE INTERFACE
            if (typeof Android !== 'undefined') {
                console.log("üöÄ Starting Android Native Service...");
                try {
                    Android.startNativeBroadcast(
                        String(state.driverId || 'Unknown'),
                        String(state.driverRoute || 'Unknown'),
                        String(state.driverUsername || '')
                    );
                    // IMPORTANT: We do NOT return here. We let the UI stay active.
                    // We do NOT start navigator.geolocation to avoid conflict.
                    return; 
                } catch (error) {
                    console.error('Error starting Android service:', error);
                }
            }

            // 3. BROWSER FALLBACK (If not in Android App)
            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                state.watchId = navigator.geolocation.watchPosition(
                    (pos) => app.processLocation(pos.coords),
                    (err) => console.error("GPS Error", err),
                    options
                );
            } else {
                alert("Geolocation not supported");
                app.stopBroadcast();
            }
        },

        // Unified Location Processor
        processLocation: (coords) => {
            if (!state.isBroadcasting) return;

            const { latitude, longitude, accuracy, speed } = coords;
            
            // Update Dashboard UI
            let rawSpeedKmh = (speed || 0) * 3.6;
            if (rawSpeedKmh < 0) rawSpeedKmh = 0;
            document.getElementById('val-speed').innerHTML = `${rawSpeedKmh.toFixed(1)}<span class="text-[10px] ml-0.5 text-slate-400 font-sans">km/h</span>`;
            document.getElementById('val-accuracy').innerText = Math.round(accuracy) + 'm';

            // Map Update
            if (state.driverMarker) {
                state.driverMarker.setLatLng([latitude, longitude]);
                if(state.driverMap) state.driverMap.panTo([latitude, longitude]);
            }

            // MQTT Publish (Throttled to 1 sec)
            const now = Date.now();
            if (now - state.lastSentTime < 1000) return; 
            state.lastSentTime = now;

            if (state.client && state.isConnected) {
                const payload = JSON.stringify({
                    id: state.driverId,
                    route: state.driverRoute,
                    username: state.driverUsername,
                    lat: latitude,
                    lng: longitude,
                    acc: accuracy,
                    speed: rawSpeedKmh.toFixed(1),
                    ts: now
                });
                state.client.publish(CONFIG.topics.location, payload, { retain: true });
            }
        },

        // Called by Android Java
        handleNativeLocationUpdate: (lat, lng, acc, speed) => {
            // Pass data to common processor
            app.processLocation({
                latitude: lat,
                longitude: lng,
                accuracy: acc,
                speed: speed 
            });
        },

        stopBroadcast: async () => {
            if (typeof Android !== 'undefined') {
                try { Android.stopNativeBroadcast(); } catch (e) {}
            }

            state.isBroadcasting = false;
            app.updateBroadcastUI(false);
            app.releaseWakeLock();
            
            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }
            if (state.uptimeInterval) clearInterval(state.uptimeInterval);

            // Send Offline Status
            if (state.client && state.isConnected) {
                  state.client.publish(CONFIG.topics.location, JSON.stringify({
                    id: state.driverId,
                    status: 'offline'
                  }), { retain: true });
            }
            app.showSummary();
        },

        showSummary: () => {
            const modal = document.getElementById('trip-summary-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('z-50');
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            if (window.confetti) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        },

        closeSummary: () => {
            const modal = document.getElementById('trip-summary-modal');
            modal.style.opacity = '0';
            setTimeout(() => { modal.classList.add('pointer-events-none'); }, 300);
            app.goHome(); 
        },

        updateBroadcastUI: (isActive) => {
            const btn = document.getElementById('broadcast-btn');
            const glow = document.getElementById('broadcast-glow');
            const title = document.getElementById('broadcast-status-title');
            const icon = document.getElementById('broadcast-icon');

            if (isActive) {
                btn.innerText = "STOP TRIP";
                btn.classList.add('from-red-500', 'to-red-600', 'animate-pulse');
                glow.style.opacity = '1';
                title.innerText = "Broadcasting";
                icon.classList.add('text-green-500');
            } else {
                btn.innerText = "START TRIP";
                btn.classList.remove('from-red-500', 'to-red-600', 'animate-pulse');
                glow.style.opacity = '0';
                title.innerText = "Ready?";
                icon.classList.remove('text-green-500');
            }
        },

        // --- Student Map ---
        initMap: () => {
            setTimeout(() => {
                if (!state.map) {
                    state.map = L.map('map', { zoomControl: false }).setView(CONFIG.uiuCoords, 14);
                    L.control.zoom({ position: 'bottomright' }).addTo(state.map);
                    
                    const isDark = document.documentElement.classList.contains('dark');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OSM',
                        className: isDark ? 'dark-map-tiles' : ''
                    }).addTo(state.map);

                    const uiuIcon = L.divIcon({ className: '', html: '<div class="text-2xl">üéì</div>', iconSize: [30, 30] });
                    L.marker(CONFIG.uiuCoords, {icon: uiuIcon}).addTo(state.map);
                }
                state.map.invalidateSize();
            }, 100);
        },

        updateMapStyle: () => {
            if (!state.map) return;
            state.map.eachLayer((layer) => { if (layer instanceof L.TileLayer) state.map.removeLayer(layer); });
            const isDark = document.documentElement.classList.contains('dark');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM',
                className: isDark ? 'dark-map-tiles' : ''
            }).addTo(state.map);
        },

        createBusIcon: (id, colorClass) => {
             return L.divIcon({
                className: 'custom-bus-pin', 
                html: `<div class="${colorClass} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-lg relative z-10">${id}<div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 ${colorClass} rotate-45 z-0"></div></div>`,
                iconSize: [40, 48], iconAnchor: [20, 48], popupAnchor: [0, -48]
            });
        },

        updateBusMarker: async (data) => {
            const { id, lat, lng, acc } = data;
            let colorClass = BUS_STYLES.default;
            if (id.startsWith('K')) colorClass = BUS_STYLES['K']; 
            else if (id.startsWith('N')) colorClass = BUS_STYLES['N']; 
            else if (id.startsWith('A')) colorClass = BUS_STYLES['A']; 
            else if (data.route && data.route.includes('To UIU')) colorClass = BUS_STYLES.to_uiu;
            else if (data.route && data.route.includes('From UIU')) colorClass = BUS_STYLES.from_uiu;

            if (state.markers[id]) {
                state.markers[id].setLatLng([lat, lng]);
            } else {
                const icon = app.createBusIcon(id, colorClass);
                const marker = L.marker([lat, lng], { icon: icon }).addTo(state.map);
                marker.bindPopup(`<div class="text-center p-2"><b class="text-brand-500 block mb-1">Bus ${app.escapeHtml(id)}</b><p class="text-xs text-slate-500">${app.escapeHtml(data.route)}</p></div>`);
                state.markers[id] = marker;
                app.updateBusCount();
            }
        },

        removeBusMarker: (id) => {
            if (state.markers[id]) {
                state.map.removeLayer(state.markers[id]);
                delete state.markers[id];
                app.updateBusCount();
            }
        },

        updateBusCount: () => { document.getElementById('count-buses').innerText = Object.keys(state.markers).length; },
        
        updateBusList: () => {
            const list = document.getElementById('bus-list');
            const buses = Object.values(state.activeBuses);
            
            // 1. Show Loading or Empty State
            if (buses.length === 0) {
                if (!list.querySelector('.fa-satellite-dish')) {
                    list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm"><i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>Searching for buses...</div>`;
                }
                return;
            }
            
            // Remove loader if exists
            const loader = list.querySelector('.fa-satellite-dish');
            if (loader) loader.parentElement.remove();

            // 2. Add or Update Bus Items
            buses.forEach(bus => {
                let item = document.getElementById(`bus-${bus.id}`);
                
                // Create Item if not exists
                if (!item) {
                    item = document.createElement('div');
                    item.id = `bus-${bus.id}`;
                    item.className = "flex items-center justify-between p-4 mb-2 bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-100 dark:border-slate-700/50 rounded-2xl cursor-pointer hover:bg-white dark:hover:bg-slate-700 transition-all shadow-sm hover:shadow-md";
                    item.onclick = () => app.focusBus(bus.id);
                    
                    let bgClass = "bg-orange-500";
                    if (bus.id.startsWith('K')) bgClass = "bg-blue-500";
                    else if (bus.id.startsWith('N')) bgClass = "bg-green-500";
                    else if (bus.id.startsWith('A')) bgClass = "bg-purple-500";
                    else if (bus.route && bus.route.includes('To UIU')) bgClass = "bg-green-600";
                    else if (bus.route && bus.route.includes('From UIU')) bgClass = "bg-red-600";

                    item.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full ${bgClass} text-white flex items-center justify-center font-bold">
                                ${app.escapeHtml(bus.id)}
                            </div>
                            <div>
                                <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${app.escapeHtml(bus.route || 'Unknown')}</p>
                                <div class="flex items-center gap-2">
                                    <p class="text-[10px] text-green-500 transition-opacity duration-200">Active Now</p>
                                    <p class="text-[10px] text-slate-400">| <span id="speed-${bus.id}">${Number(bus.speed || 0).toFixed(1)}</span> km/h</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 dark:text-slate-400 truncate max-w-[80px]">${app.escapeHtml(bus.username || '')}</span>
                            <i class="fas fa-chevron-right text-slate-300"></i>
                        </div>
                    `;
                    list.appendChild(item);
                } else {
                    // Update Speed dynamically without re-rendering HTML
                    const speedEl = document.getElementById(`speed-${bus.id}`);
                    if (speedEl) {
                        speedEl.innerText = Number(bus.speed || 0).toFixed(1);
                    }
                }
            });

            // 3. Remove Stale Items (Ghosts)
            Array.from(list.children).forEach(child => {
                if (child.id.startsWith('bus-') && !state.activeBuses[child.id.replace('bus-', '')]) {
                    child.remove();
                }
            });
        },

        focusBus: (id) => {
            if (state.markers[id]) {
                state.map.setView(state.markers[id].getLatLng(), 16);
                state.markers[id].openPopup();
                app.toggleBottomSheet();
            }
        },

        toggleBottomSheet: () => {
            const sheet = document.getElementById('bottom-sheet');
            if (sheet.classList.contains('translate-y-0')) {
                sheet.classList.remove('translate-y-0');
                sheet.classList.add('translate-y-[80%]');
            } else {
                sheet.classList.remove('translate-y-[80%]');
                sheet.classList.add('translate-y-0');
            }
        }
    };

    window.app = app;
    window.state = state;
    window.addEventListener('DOMContentLoaded', app.init);
    window.app.handleAndroidLocation = window.handleAndroidLocation;
</script>
</body>
</html>
