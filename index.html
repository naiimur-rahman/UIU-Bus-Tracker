<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UIU Bus Tracker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { brand: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 900: '#7c2d12' } },
                    animation: { 'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { 'pulse-glow': { '0%, 100%': { opacity: '1', boxShadow: '0 0 0 0px rgba(34, 197, 94, 0.7)' }, '50%': { opacity: '.5', boxShadow: '0 0 0 15px rgba(34, 197, 94, 0)' } } }
                }
            }
        }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .glass { background: rgba(255, 255, 255, 0.65); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .dark .glass { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2); }
        .dark-map-tiles { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        .view-section { position: absolute; inset: 0; opacity: 0; pointer-events: none; visibility: hidden; transition: all 0.3s; z-index: 0; display: flex; flex-direction: column; }
        .view-active { opacity: 1 !important; pointer-events: auto !important; z-index: 100 !important; visibility: visible !important; }
        .pulse-ring::before { content: ''; position: absolute; inset: 0; border-radius: 50%; border: 2px solid white; animation: ring 1.5s infinite; }
        @keyframes ring { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .leaflet-div-icon { background: transparent; border: none; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-gray-100 font-sans h-[100dvh] w-screen overflow-hidden transition-colors duration-300 relative">

    <div id="view-landing" class="view-section view-active p-6 justify-center items-center h-full">
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-brand-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-white text-4xl">
                <i class="fas fa-bus"></i>
            </div>
            <h1 class="text-3xl font-bold">UIU <span class="text-brand-500">Tracker</span></h1>
            <p class="text-xs text-slate-400">Native Android Edition</p>
        </div>
        <div class="w-full max-w-sm space-y-4">
            <button onclick="app.setRole('student')" class="glass w-full p-6 rounded-xl flex items-center justify-between hover:border-brand-500 border-l-4 border-transparent hover:border-l-brand-500 transition-all">
                <div class="text-left">
                    <h3 class="font-bold">Student Map</h3>
                    <p class="text-xs text-slate-500">Track buses live</p>
                </div>
                <i class="fas fa-map-marked-alt text-2xl text-blue-500"></i>
            </button>
            <button onclick="app.setRole('driver-select')" class="glass w-full p-6 rounded-xl flex items-center justify-between hover:border-brand-500 border-l-4 border-transparent hover:border-l-brand-500 transition-all">
                <div class="text-left">
                    <h3 class="font-bold">Captain Login</h3>
                    <p class="text-xs text-slate-500">Start driving</p>
                </div>
                <i class="fas fa-id-badge text-2xl text-brand-500"></i>
            </button>
        </div>
        
        <div class="absolute bottom-6 text-center w-full left-0">
            <p class="text-[10px] text-slate-400">Developed by <span class="text-brand-500 font-bold">Naimur Rahman</span></p>
        </div>
    </div>

    <div id="view-driver-select" class="view-section p-6 bg-slate-50 dark:bg-slate-900">
        <div class="flex items-center mb-6">
            <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-brand-500"><i class="fas fa-arrow-left"></i></button>
            <h2 class="ml-4 text-xl font-bold">Select Route</h2>
        </div>
        
        <div id="route-sub-select" class="hidden absolute inset-0 bg-white/95 dark:bg-slate-900/95 z-50 flex flex-col items-center justify-center p-6 backdrop-blur">
            <h3 class="text-xl font-bold mb-6">Trip Details</h3>
            <input type="text" id="driver-username-input" placeholder="Your Name (Optional)" class="w-full max-w-xs p-4 rounded-xl glass mb-4 bg-transparent border border-slate-300 dark:border-slate-700 outline-none focus:border-brand-500 transition-colors">
            
            <button onclick="app.confirmRoute('To UIU')" class="w-full max-w-xs bg-green-500 hover:bg-green-600 text-white p-4 rounded-xl mb-2 font-bold transition-colors">
                Going to Campus <span class="block text-[10px] font-normal opacity-80">From City &rarr; UIU</span>
            </button>
            <button onclick="app.confirmRoute('From UIU')" class="w-full max-w-xs bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-xl mb-6 font-bold transition-colors">
                Leaving Campus <span class="block text-[10px] font-normal opacity-80">UIU &rarr; To City</span>
            </button>
            <button onclick="document.getElementById('route-sub-select').classList.add('hidden')" class="text-slate-400">Cancel</button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="app.selectRoute('Kuril', 'K')" class="glass p-6 rounded-xl flex flex-col items-center gap-2 hover:bg-brand-50 transition-colors"><i class="fas fa-road text-blue-500 text-2xl"></i><b>Kuril</b></button>
            <button onclick="app.selectRoute('Notun Bazar', 'N')" class="glass p-6 rounded-xl flex flex-col items-center gap-2 hover:bg-brand-50 transition-colors"><i class="fas fa-store text-green-500 text-2xl"></i><b>N. Bazar</b></button>
            <button onclick="app.selectRoute('Aftab Nagar', 'A')" class="glass p-6 rounded-xl flex flex-col items-center gap-2 hover:bg-brand-50 transition-colors"><i class="fas fa-city text-purple-500 text-2xl"></i><b>A. Nagar</b></button>
            <button onclick="app.selectRoute('Transport', 'R')" class="glass p-6 rounded-xl flex flex-col items-center gap-2 hover:bg-brand-50 transition-colors"><i class="fas fa-bus text-orange-500 text-2xl"></i><b>Regular</b></button>
        </div>
        
        <div id="selection-loader" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-40 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="font-bold animate-pulse">Syncing...</p>
        </div>
    </div>

    <div id="view-driver-dashboard" class="view-section flex flex-col h-full bg-slate-50 dark:bg-slate-900">
        <div class="absolute top-0 left-0 right-0 p-4 z-30 flex justify-between pointer-events-none">
            <button onclick="app.goHome()" class="pointer-events-auto w-10 h-10 rounded-full glass bg-red-500 text-white flex items-center justify-center shadow-lg"><i class="fas fa-power-off"></i></button>
            <div class="glass bg-slate-900/90 text-white px-3 py-1 rounded-full text-xs font-mono" id="debug-status">Waiting for GPS...</div>
        </div>

        <div class="h-[60%] w-full relative z-0 bg-slate-200 dark:bg-slate-800">
            <div id="driver-map" class="w-full h-full"></div>
        </div>

        <div class="flex-grow flex flex-col items-center p-6 -mt-12 relative z-20">
            <div class="glass w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center bg-white/80 dark:bg-slate-800/80 backdrop-blur-xl border border-white/20">
                <div class="flex justify-between items-center mb-6">
                    <div class="text-left">
                        <h2 class="text-xl font-bold" id="broadcast-status-title">Ready?</h2>
                        <p class="text-xs text-slate-500" id="broadcast-status-desc">Tap to start</p>
                    </div>
                    <div class="relative w-12 h-12 flex items-center justify-center">
                        <div id="broadcast-glow" class="absolute inset-0 rounded-full opacity-0 transition-opacity"></div>
                        <i id="broadcast-icon" class="fas fa-location-arrow text-slate-300 dark:text-slate-600 transition-colors text-xl relative z-10"></i>
                    </div>
                </div>
                
                <button id="broadcast-btn" onclick="app.toggleBroadcast()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 uppercase tracking-widest">
                    START TRIP
                </button>
            </div>

            <div class="grid grid-cols-3 gap-3 w-full max-w-sm mt-4">
                <div class="glass p-3 rounded-xl text-center"><p class="text-[9px] uppercase text-slate-400">Speed</p><p id="val-speed" class="font-mono text-lg font-bold">0</p></div>
                <div class="glass p-3 rounded-xl text-center"><p class="text-[9px] uppercase text-slate-400">GPS</p><p id="val-accuracy" class="font-mono text-lg font-bold">--</p></div>
                <div class="glass p-3 rounded-xl text-center"><p class="text-[9px] uppercase text-slate-400">Time</p><p id="val-uptime" class="font-mono text-lg font-bold">00:00</p></div>
            </div>
        </div>
        
        <div id="trip-summary-modal" class="absolute inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
             <div class="w-32 h-32 bg-gradient-to-tr from-brand-500 to-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-lg">
                 <i class="fas fa-heart text-6xl text-white"></i>
             </div>
             <h2 class="text-4xl font-black text-white mb-2 text-center">Trip Ended</h2>
             <p class="text-slate-400 mb-8 text-center px-4 max-w-xs">Thank you for your service!</p>
             <button onclick="app.closeSummary()" class="mt-4 px-8 py-3 bg-white text-brand-600 font-bold rounded-full hover:scale-105 transition-transform shadow-lg">Close</button>
        </div>
    </div>

    <div id="view-student" class="view-section flex flex-col h-full bg-slate-200">
        <div class="absolute top-4 left-4 z-30">
            <button onclick="app.goHome()" class="w-10 h-10 rounded-full bg-white text-slate-800 shadow-lg flex items-center justify-center hover:scale-110 transition-transform"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div id="map" class="h-full w-full outline-none z-0"></div>
        <div class="bg-white dark:bg-slate-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 p-4 max-h-[40vh] overflow-y-auto" id="bottom-sheet">
            <div class="w-full flex justify-center pt-2 pb-4 cursor-pointer" onclick="app.toggleBottomSheet()">
                <div class="w-16 h-1.5 bg-slate-300 dark:bg-slate-600 rounded-full"></div>
            </div>
            <div id="bus-list" class="space-y-2">
                <div class="text-center py-8 text-slate-400 text-sm">
                    <i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>
                    Searching for buses...
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script type="module">
        /** APP CONFIG */
        const CONFIG = {
            mqtt: { host: '09872002dac9410e9af391b1a7066483.s1.eu.hivemq.cloud', port: 8884, user: 'naimur', pass: 'Sohan786@' },
            topics: { location: 'uiu/bus/location', presence: 'uiu/presence' },
            coords: [23.79790, 90.44970]
        };

        const BUS_STYLES = {
            'K': 'bg-blue-500', 'N': 'bg-green-500', 'A': 'bg-purple-500', 'default': 'bg-orange-500',
            'to_uiu': 'bg-green-600', 'from_uiu': 'bg-red-600'
        };

        const state = {
            client: null, isConnected: false, driverId: null, driverRoute: null, driverUsername: null,
            driverMap: null, driverMarker: null, map: null, markers: {}, circles: {}, activeBuses: {},
            isBroadcasting: false, startTime: null, uptimeInterval: null, currentSmoothedSpeed: 0,
            activeUsers: new Map()
        };

        const app = {
            init: () => {
                app.loadTheme();
                app.connectMqtt();
                
                // Recover Driver Session
                const savedId = localStorage.getItem('active_driver_id');
                if (savedId) {
                    state.driverId = savedId;
                    state.driverRoute = localStorage.getItem('active_driver_route');
                    state.driverUsername = localStorage.getItem('active_driver_username');
                    app.setRole('driver-dashboard');
                    document.getElementById('driver-assigned-id').innerText = `${state.driverRoute} [${state.driverId}]`;
                    app.initDriverMap();
                }
                
                // 5 Minute Timeout Cleanup
                setInterval(app.cleanupStaleUsers, 10000);
            },

            // --- Theme & View Logic ---
            escapeHtml: (text) => {
                if (!text) return text;
                return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            },

            toggleTheme: () => {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark'); localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark'); localStorage.setItem('theme', 'dark');
                }
                app.updateMapStyle();
            },

            loadTheme: () => {
                const theme = localStorage.getItem('theme');
                if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }
            },

            switchView: (id) => {
                document.getElementById('selection-loader').classList.add('hidden');
                document.getElementById('route-sub-select').classList.add('hidden');
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('view-active');
                    el.style.opacity = '0'; el.style.pointerEvents = 'none'; el.style.zIndex = '0';
                });
                const target = document.getElementById(id);
                if (target) {
                    target.classList.add('view-active');
                    void target.offsetWidth; 
                    target.style.opacity = '1'; target.style.pointerEvents = 'auto'; target.style.zIndex = '100'; target.style.visibility = 'visible';
                }
                const globalControls = document.getElementById('global-controls');
                if (globalControls) {
                    if (id === 'view-landing') globalControls.classList.remove('invisible', 'opacity-0');
                    else globalControls.classList.add('invisible', 'opacity-0');
                }
            },

            setRole: (role) => {
                state.role = role;
                if (role === 'student') { app.switchView('view-student'); app.initMap(); }
                else if (role === 'driver-select') app.switchView('view-driver-select');
                else if (role === 'driver-dashboard') app.switchView('view-driver-dashboard');
            },

            goHome: async () => {
                try {
                    if (state.isBroadcasting) {
                        const confirmExit = confirm("Stop broadcasting?");
                        if (!confirmExit) return;
                        await app.stopBroadcast();
                    }
                    state.driverId = null; state.driverRoute = null; state.isBroadcasting = false;
                    state.activeBuses = {};
                    if (state.driverMap) { try { state.driverMap.remove(); } catch(e){} state.driverMap = null; }
                    state.driverMarker = null;
                    localStorage.removeItem('active_driver_id');
                    localStorage.removeItem('active_driver_route');
                } catch (e) {}
                app.switchView('view-landing');
            },

            // --- MQTT Logic ---
            connectMqtt: () => {
                const connectUrl = `wss://${CONFIG.mqtt.host}:${CONFIG.mqtt.port}/mqtt`;
                state.client = mqtt.connect(connectUrl, {
                    username: CONFIG.mqtt.username, password: CONFIG.mqtt.password,
                    clientId: 'web_' + Math.random().toString(16).substr(2, 8), clean: true
                });

                state.client.on('connect', () => {
                    state.isConnected = true;
                    app.updateConnectionStatus('connected');
                    state.client.subscribe(CONFIG.topics.location);
                });

                state.client.on('message', (topic, message) => {
                    try {
                        const data = JSON.parse(message.toString());
                        if (topic === CONFIG.topics.location) app.handleLocationUpdate(data);
                    } catch (e) {}
                });

                state.client.on('close', () => { state.isConnected = false; app.updateConnectionStatus('offline'); });
            },

            updateConnectionStatus: (status) => {
                const dot = document.getElementById('driver-connection-dot');
                const text = document.getElementById('driver-connection-text');
                if (!dot || !text) return;
                
                if (status === 'connected') {
                    dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-lg";
                    text.innerText = "ONLINE";
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-red-500";
                    text.innerText = "OFFLINE";
                }
            },

            cleanupStaleUsers: () => {
                const now = Date.now();
                let changed = false;
                for (const id in state.activeBuses) {
                    // Keep buses on map for 5 MINUTES (300,000ms)
                    if (now - state.activeBuses[id].ts > 300000) { 
                        delete state.activeBuses[id];
                        app.removeBusMarker(id);
                        changed = true;
                    }
                }
                if (changed) app.updateBusList();
            },

            // --- Location Handlers ---
            handleLocationUpdate: (data) => {
                // If offline status received
                if (data.status === 'offline') {
                    delete state.activeBuses[data.id];
                    app.removeBusMarker(data.id);
                    app.updateBusList();
                    return;
                }

                // If I am the driver, ignore my own MQTT echo (since Android Native sends it)
                if (state.driverId && data.id === state.driverId) return;

                // Update Local State
                state.activeBuses[data.id] = { ...data, ts: Date.now() };

                // Update UI if in Student Mode
                if (state.role === 'student') {
                    app.updateBusMarker(data);
                    app.updateBusList();
                }
            },

            // --- Driver Setup Logic ---
            selectRoute: (name, prefix) => {
                state.tempRouteName = name; state.tempRoutePrefix = prefix;
                const savedName = localStorage.getItem('saved_username');
                if (savedName) document.getElementById('driver-username-input').value = savedName;
                document.getElementById('route-sub-select').classList.remove('hidden');
            },

            confirmRoute: (direction) => {
                const name = state.tempRouteName;
                const prefix = state.tempRoutePrefix;
                const fullRouteName = `${name} (${direction})`;
                const username = document.getElementById('driver-username-input').value.trim() || null;

                document.getElementById('route-sub-select').classList.add('hidden');
                document.getElementById('selection-loader').classList.remove('hidden');

                setTimeout(() => {
                    const assignedId = app.assignNextId(prefix);
                    state.driverId = assignedId;
                    state.driverRoute = fullRouteName;
                    state.driverUsername = username;

                    localStorage.setItem('active_driver_id', assignedId);
                    localStorage.setItem('active_driver_route', fullRouteName);
                    localStorage.setItem('active_driver_dest', name);
                    localStorage.setItem('active_driver_dir', direction);
                    if (username) {
                        localStorage.setItem('active_driver_username', username);
                        localStorage.setItem('saved_username', username);
                    }

                    document.getElementById('driver-assigned-id').innerText = `${fullRouteName} [${assignedId}]`;
                    document.getElementById('selection-loader').classList.add('hidden');
                    
                    app.switchView('view-driver-dashboard');
                    app.initDriverMap();
                }, 500);
            },

            assignNextId: (prefix) => {
                const ids = Object.keys(state.activeBuses)
                    .filter(id => id.startsWith(prefix))
                    .map(id => parseInt(id.replace(prefix, '')))
                    .filter(n => !isNaN(n)).sort((a,b)=>a-b);
                let next = 1;
                for (const n of ids) { if(n === next) next++; else break; }
                return prefix + next;
            },

            // --- Driver Map ---
            initDriverMap: () => {
                const el = document.getElementById('driver-map');
                if(!el) return;
                if (state.driverMap) { state.driverMap.remove(); state.driverMap = null; }

                const COORDS = { 'UIU': CONFIG.coords, 'Kuril': [23.822339, 90.420163], 'Notun Bazar': [23.797881, 90.424652], 'Aftab Nagar': [23.767860, 90.425833], 'Transport': CONFIG.coords };
                const dest = localStorage.getItem('active_driver_dest') || 'Transport';
                const dir = localStorage.getItem('active_driver_dir');
                let start = (dir === 'From UIU') ? COORDS['UIU'] : (COORDS[dest] || CONFIG.coords);

                setTimeout(() => {
                    state.driverMap = L.map('driver-map', { zoomControl: false }).setView(start, 13);
                    const isDark = document.documentElement.classList.contains('dark');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'OSM', className: isDark ? 'dark-map-tiles' : ''
                    }).addTo(state.driverMap);
                    
                    // Simple self-centering button
                    const btn = L.control({position: 'bottomright'});
                    btn.onAdd = () => {
                        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                        div.innerHTML = '<a href="#" title="Center" style="background:white; width:40px; height:40px; line-height:40px; text-align:center; display:block;"><i class="fas fa-crosshairs"></i></a>';
                        div.onclick = (e) => { e.preventDefault(); if(state.lastLat) state.driverMap.setView([state.lastLat, state.lastLng], 16); };
                        return div;
                    };
                    btn.addTo(state.driverMap);
                }, 200);
            },

            // --- Driver Broadcast Logic ---
            toggleBroadcast: () => {
                if (state.isBroadcasting) app.stopBroadcast();
                else app.startBroadcast();
            },

            startBroadcast: () => {
                if (window.Android) {
                    state.isBroadcasting = true;
                    app.updateBroadcastUI(true);
                    
                    state.tripStartTime = Date.now();
                    state.uptimeInterval = setInterval(() => {
                        const diff = Math.floor((Date.now() - state.tripStartTime) / 1000);
                        const m = Math.floor(diff / 60).toString().padStart(2, '0');
                        const s = (diff % 60).toString().padStart(2, '0');
                        document.getElementById('val-uptime').innerText = `${m}:${s}`;
                    }, 1000);

                    // Call Android Native Service
                    window.Android.startNativeBroadcast(
                        state.driverId, 
                        state.driverRoute, 
                        state.driverUsername || ""
                    );
                } else {
                    alert("âš ï¸ Please open this in the Android App to broadcast background location!");
                }
            },

            stopBroadcast: () => {
                if (window.Android) window.Android.stopNativeBroadcast();
                
                state.isBroadcasting = false;
                app.updateBroadcastUI(false);
                if (state.uptimeInterval) clearInterval(state.uptimeInterval);
                
                // Send one last offline message (Android handles this too, but redundant is safe)
                if (state.client && state.isConnected) {
                    state.client.publish(CONFIG.topics.location, JSON.stringify({ id: state.driverId, status: 'offline' }));
                }
                app.showSummary();
            },

            // --- Android Bridge (Called by Java) ---
            handleAndroidLocation: (lat, lng, acc, speed) => {
                // If this is called, we know the service is running, so force UI state
                if (!state.isBroadcasting) {
                    state.isBroadcasting = true;
                    app.updateBroadcastUI(true);
                }

                document.getElementById('debug-status').innerText = "Live: " + new Date().toLocaleTimeString();
                document.getElementById('val-speed').innerText = (speed * 3.6).toFixed(1) + " km/h";
                document.getElementById('val-accuracy').innerText = Math.round(acc) + "m";

                if (state.driverMap) {
                    if (!state.driverMarker) {
                        const iconHtml = `<div class="bg-blue-600 w-6 h-6 rounded-full border-2 border-white shadow-lg flex items-center justify-center relative pulse-ring"><div class="w-2 h-2 bg-white rounded-full"></div></div>`;
                        const icon = L.divIcon({ className: '', html: iconHtml, iconSize: [24, 24] });
                        state.driverMarker = L.marker([lat, lng], {icon: icon}).addTo(state.driverMap);
                    } else {
                        state.driverMarker.setLatLng([lat, lng]);
                    }
                    state.driverMap.panTo([lat, lng]);
                }
                state.lastLat = lat; state.lastLng = lng;
            },

            updateBroadcastUI: (active) => {
                const btn = document.getElementById('broadcast-btn');
                const glow = document.getElementById('broadcast-glow');
                const title = document.getElementById('broadcast-status-title');
                const icon = document.getElementById('broadcast-icon');
                if(!btn) return;

                if (active) {
                    // Switch to dashboard if not there
                    if(!document.getElementById('view-driver-dashboard').classList.contains('view-active')) {
                        app.switchView('view-driver-dashboard');
                    }
                    btn.innerText = "STOP TRIP";
                    btn.classList.remove('bg-brand-500', 'hover:bg-brand-600');
                    btn.classList.add('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                    glow.className = "absolute inset-0 rounded-full animate-pulse-glow bg-green-400";
                    glow.style.opacity = '1';
                    title.innerText = "Broadcasting";
                    icon.classList.remove('text-slate-300', 'dark:text-slate-600');
                    icon.classList.add('text-green-500');
                } else {
                    btn.innerText = "START TRIP";
                    btn.classList.remove('bg-red-500', 'hover:bg-red-600', 'animate-pulse');
                    btn.classList.add('bg-brand-500', 'hover:bg-brand-600');
                    glow.style.opacity = '0';
                    title.innerText = "Ready?";
                    icon.classList.add('text-slate-300', 'dark:text-slate-600');
                    icon.classList.remove('text-green-500');
                }
            },

            showSummary: () => {
                const modal = document.getElementById('trip-summary-modal');
                modal.classList.remove('opacity-0', 'pointer-events-none', 'z-[-1]');
                modal.classList.add('z-50'); modal.style.opacity = '1'; modal.style.pointerEvents = 'auto';
                if (window.confetti) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            },

            closeSummary: () => {
                if (window.confetti) { try { window.confetti.reset(); } catch(e) {} }
                const modal = document.getElementById('trip-summary-modal');
                modal.classList.add('opacity-0', 'pointer-events-none', 'z-[-1]');
                modal.classList.remove('z-50'); modal.style.opacity = '0';
                app.goHome();
            },

            // --- Student Map Logic ---
            initMap: () => {
                setTimeout(() => {
                    if (!state.map) {
                        state.map = L.map('map', { zoomControl: false }).setView(CONFIG.coords, 14);
                        L.control.zoom({ position: 'bottomright' }).addTo(state.map);
                        
                        const uiuIcon = L.divIcon({ className: '', html: '<div class="text-2xl">ðŸŽ“</div>', iconSize: [30, 30] });
                        L.marker(CONFIG.coords, {icon: uiuIcon}).addTo(state.map).bindPopup("UIU Campus");
                        app.updateMapStyle();
                    }
                    requestAnimationFrame(() => { state.map.invalidateSize(); });
                }, 100);
            },

            updateMapStyle: () => {
                if (!state.map) return;
                state.map.eachLayer(l => { if (l instanceof L.TileLayer) state.map.removeLayer(l); });
                const isDark = document.documentElement.classList.contains('dark');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM', className: isDark ? 'dark-map-tiles' : '' }).addTo(state.map);
            },

            createBusIcon: (id, colorClass) => {
                return L.divIcon({
                    className: 'custom-bus-pin',
                    html: `<div class="${colorClass} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-lg relative z-10">${id}<div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 ${colorClass} rotate-45 z-0"></div></div>`,
                    iconSize: [40, 48], iconAnchor: [20, 48], popupAnchor: [0, -48]
                });
            },

            updateBusMarker: (data) => {
                const { id, lat, lng, acc } = data;
                let color = BUS_STYLES.default;
                if (id.startsWith('K')) color = BUS_STYLES['K'];
                else if (id.startsWith('N')) color = BUS_STYLES['N'];
                else if (id.startsWith('A')) color = BUS_STYLES['A'];
                
                if (state.markers[id]) {
                    state.markers[id].setLatLng([lat, lng]);
                    state.markers[id].setIcon(app.createBusIcon(id, color));
                } else {
                    const marker = L.marker([lat, lng], { icon: app.createBusIcon(id, color) }).addTo(state.map);
                    const popup = `<div class="text-center p-2"><b class="text-brand-500 block mb-1">Bus ${app.escapeHtml(id)}</b><p class="text-xs text-slate-500">${app.escapeHtml(data.route)}</p>${data.username ? `<p class="text-xs font-bold mt-1">ðŸ‘¤ ${app.escapeHtml(data.username)}</p>` : ''}</div>`;
                    marker.bindPopup(popup);
                    state.markers[id] = marker;
                    app.updateBusCount();
                }

                // Accuracy Circle
                if (acc > 20) {
                    if (state.circles[id]) { state.circles[id].setLatLng([lat, lng]); state.circles[id].setRadius(acc); }
                    else { state.circles[id] = L.circle([lat, lng], { radius: acc, color: 'transparent', fillColor: '#3b82f6', fillOpacity: 0.1 }).addTo(state.map); }
                } else if (state.circles[id]) {
                    state.map.removeLayer(state.circles[id]); delete state.circles[id];
                }
            },

            removeBusMarker: (id) => {
                if (state.markers[id]) { state.map.removeLayer(state.markers[id]); delete state.markers[id]; }
                if (state.circles[id]) { state.map.removeLayer(state.circles[id]); delete state.circles[id]; }
                app.updateBusCount();
            },

            updateBusCount: () => {
                document.getElementById('count-buses').innerText = Object.keys(state.markers).length;
            },

            updateBusList: () => {
                const list = document.getElementById('bus-list');
                const buses = Object.values(state.activeBuses);
                if (buses.length === 0) {
                    if (!list.querySelector('.fa-satellite-dish')) list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm"><i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>Searching for buses...</div>`;
                    return;
                }
                const loader = list.querySelector('.fa-satellite-dish');
                if (loader) loader.parentElement.remove();

                buses.forEach(bus => {
                    let item = document.getElementById(`bus-${bus.id}`);
                    if (!item) {
                        item = document.createElement('div');
                        item.id = `bus-${bus.id}`;
                        item.className = "flex items-center justify-between p-4 mb-2 bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur-sm border border-slate-100 dark:border-slate-700/50 rounded-2xl cursor-pointer hover:bg-white dark:hover:bg-slate-700 transition-all shadow-sm";
                        item.onclick = () => app.focusBus(bus.id);
                        
                        let color = "bg-orange-500";
                        if (bus.id.startsWith('K')) color = "bg-blue-500";
                        else if (bus.id.startsWith('N')) color = "bg-green-500";
                        else if (bus.id.startsWith('A')) color = "bg-purple-500";

                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${color} text-white flex items-center justify-center font-bold">${app.escapeHtml(bus.id)}</div>
                                <div>
                                    <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${app.escapeHtml(bus.route)}</p>
                                    <div class="flex items-center gap-2">
                                        <p class="text-[10px] text-green-500">Active</p>
                                        <p class="text-[10px] text-slate-400">| <span id="speed-${bus.id}">${Number(bus.speed||0).toFixed(1)}</span> km/h</p>
                                    </div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-slate-300"></i>
                        `;
                        list.appendChild(item);
                    } else {
                        const sEl = document.getElementById(`speed-${bus.id}`);
                        if(sEl) sEl.innerText = Number(bus.speed||0).toFixed(1);
                    }
                });
                
                // Cleanup removed list items
                Array.from(list.children).forEach(child => {
                    if (child.id.startsWith('bus-') && !state.activeBuses[child.id.replace('bus-', '')]) child.remove();
                });
            },

            focusBus: (id) => {
                if (state.markers[id]) {
                    state.map.setView(state.markers[id].getLatLng(), 16);
                    state.markers[id].openPopup();
                    app.toggleBottomSheet();
                }
            },

            toggleBottomSheet: () => {
                const sheet = document.getElementById('bottom-sheet');
                if (sheet.classList.contains('translate-y-0')) {
                    sheet.classList.remove('translate-y-0'); sheet.classList.add('translate-y-[80%]');
                } else {
                    sheet.classList.remove('translate-y-[80%]'); sheet.classList.add('translate-y-0');
                }
            }
        };

        window.app = app;
        window.state = state;
        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
