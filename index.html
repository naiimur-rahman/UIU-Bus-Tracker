<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>UIU Bus Tracker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#fff7ed',
                            100: '#ffedd5',
                            500: '#f97316', // Orange
                            600: '#ea580c',
                            900: '#7c2d12',
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: '1', boxShadow: '0 0 0 0px rgba(34, 197, 94, 0.7)' },
                            '50%': { opacity: '.5', boxShadow: '0 0 0 15px rgba(34, 197, 94, 0)' },
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Map Tiles Filter for Dark Mode */
        .dark-map-tiles {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        /* View Transitions */
        .view-section {
            position: absolute;
            inset: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            visibility: hidden;
            overflow-y: hidden; /* Fixed screen */
            z-index: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* Force Active View to be Visible */
        .view-active {
            opacity: 1 !important;
            pointer-events: auto !important;
            transform: scale(1) !important;
            z-index: 100 !important;
            visibility: visible !important;
        }

        /* Progress Bar Animation */
        .progress-bar-animated {
            transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes drive {
            0% { transform: translateY(0) rotate(3deg); }
            50% { transform: translateY(-6px) rotate(0deg); }
            100% { transform: translateY(0) rotate(3deg); }
        }
        .animate-drive {
            animation: drive 1.5s ease-in-out infinite;
        }
        
        .pulse-ring::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; right: 0;
            border-radius: 50%;
            border: 2px solid white;
            animation: ring 1.5s infinite;
        }
        @keyframes ring {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        /* Custom Marker CSS - Reset */
        .leaflet-div-icon {
            background: transparent;
            border: none;
        }

        /* Prevent Scroll Bounce */
        body {
            overscroll-behavior: none;
        }

        #view-profile {
            background-color: rgb(248 250 252) !important;
        }
        .dark #view-profile {
            background-color: rgb(15 23 42) !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 text-slate-800 dark:text-gray-100 font-sans h-[100dvh] w-screen overflow-hidden transition-colors duration-300 relative selection:bg-brand-500 selection:text-white">

    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute -top-20 -left-20 w-64 h-64 bg-brand-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float"></div>
        <div class="absolute top-1/2 -right-20 w-72 h-72 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 2s"></div>
        <div class="absolute -bottom-20 left-1/3 w-80 h-80 bg-pink-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-float" style="animation-delay: 4s"></div>
    </div>

    <div id="global-controls" class="z-[500] relative transition-opacity duration-300 pointer-events-none">
        <button onclick="app.toggleTheme()" class="fixed top-4 right-4 w-10 h-10 rounded-full glass flex items-center justify-center text-slate-600 dark:text-yellow-400 shadow-lg hover:scale-110 transition-transform cursor-pointer pointer-events-auto">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
        </button>

        <button onclick="app.openCaptainsDeck()" class="fixed top-4 left-4 w-10 h-10 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 flex items-center justify-center text-white shadow-lg hover:scale-110 transition-transform animate-float cursor-pointer pointer-events-auto">
            <i class="fas fa-trophy"></i>
        </button>
    </div>

    <div id="view-landing" class="view-section view-active p-4 h-full z-10 flex flex-col justify-between">
        
        <div class="flex-grow flex flex-col items-center justify-center w-full max-w-sm mx-auto">
            <div class="text-center mb-4"> <div class="w-20 h-20 bg-gradient-to-tr from-brand-500 to-orange-400 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-orange-500/30 transform rotate-3 animate-drive">
                    <i class="fas fa-bus text-4xl text-white"></i>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight mb-1">
                    <span class="text-slate-800 dark:text-white">UIU</span>
                    <span class="text-brand-500">Bus Tracker</span>
                </h1>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Next Gen Campus Transport</p>
            </div>

            <div class="grid gap-3 w-full"> <button onclick="app.setRole('student')" class="glass group relative overflow-hidden p-5 rounded-2xl text-left hover:border-brand-500 transition-all duration-300">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-500 transform scale-y-0 group-hover:scale-y-100 transition-transform origin-top"></div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-1">Bus Kothay</h3>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Real-time tracking</p>
                        </div>
                        <div class="w-10 h-10 bg-blue-50 dark:bg-slate-700 rounded-full flex items-center justify-center text-blue-500 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                            <i class="fas fa-map-location-dot text-lg"></i>
                        </div>
                    </div>
                </button>

                <button onclick="app.setRole('driver-select')" class="glass group relative overflow-hidden p-5 rounded-2xl text-left hover:border-brand-500 transition-all duration-300">
                    <div class="absolute right-0 top-0 h-full w-1 bg-brand-500 transform scale-y-0 group-hover:scale-y-100 transition-transform origin-top"></div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold mb-1">Start a Trip</h3>
                            <p class="text-[10px] text-slate-500 dark:text-slate-400">Share location with others</p>
                        </div>
                        <div class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-slate-600 dark:text-slate-300 group-hover:bg-brand-500 group-hover:text-white transition-colors">
                            <i class="fas fa-id-card text-lg"></i>
                        </div>
                    </div>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 w-full mt-4"> <a href="https://naiimur-rahman.github.io/UIU-Incognito-Chat/" target="_blank" class="glass p-4 rounded-2xl hover:scale-[1.02] transition-transform text-left block border-l-4 border-l-purple-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center text-purple-500">
                            <i class="fas fa-comments text-sm"></i>
                        </div>
                        <h4 class="font-bold text-xs">Incognito Chat</h4>
                    </div>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight">Connect anonymously.</p>
                </a>

                <a href="https://naiimur-rahman.github.io/UIU-CGPA-Calculator/" target="_blank" class="glass p-4 rounded-2xl hover:scale-[1.02] transition-transform text-left block border-l-4 border-l-green-500">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-500">
                            <i class="fas fa-calculator text-sm"></i>
                        </div>
                        <h4 class="font-bold text-xs">CGPA Calculator</h4>
                    </div>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-tight">Calculate CGPA and more.</p>
                </a>
            </div>
        </div>
        
        <div class="pt-2 pb-4 text-center px-4 w-full shrink-0 z-50">
            <p class="text-xs text-slate-400 dark:text-slate-500 font-medium">
                Developed by <a href="https://www.facebook.com/naiimurr/" target="_blank" class="text-brand-500 hover:underline">Naimur Rahman</a> (CSE 242) for UIU❤️
            </p>
        </div>
    </div>

    <div id="view-captains-deck" class="view-section flex flex-col items-center p-6 h-full z-10 relative bg-slate-50 dark:bg-slate-900">
        <div class="w-full flex justify-between items-center mb-4 mt-4 shrink-0">
            <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-brand-500 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="text-2xl font-bold">Leaderboard</h2>
            <div class="w-10"></div>
        </div>

        <div class="w-full h-full overflow-y-auto pb-20 no-scrollbar">
            <div class="glass w-full rounded-3xl p-6 shadow-xl flex flex-col items-center text-center mb-6 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-brand-500/10 to-transparent"></div>
                 <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 flex items-center justify-center mb-3 shadow-lg ring-4 ring-white dark:ring-slate-700 z-10">
                    <i class="fas fa-trophy text-3xl text-white"></i>
                </div>

                <h3 id="deck-rank" class="text-xl font-black uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-yellow-500 to-orange-600 mb-1 z-10">BRONZE</h3>
                <p id="deck-points" class="text-3xl font-bold text-slate-800 dark:text-white mb-4 z-10">0 <span class="text-sm font-normal text-slate-500">pts</span></p>

                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-3 mb-2 overflow-hidden z-10">
                    <div id="deck-progress" class="bg-gradient-to-r from-brand-400 to-brand-600 h-3 rounded-full progress-bar-animated" style="width: 0%"></div>
                </div>
                <p id="next-tier-text" class="text-[10px] text-slate-400 z-10">... to next rank</p>
            </div>

            <div class="w-full mb-6">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-3 pl-2">All Tiers</h3>
                <div class="flex justify-between items-center text-[10px] text-slate-400 px-2 bg-white dark:bg-slate-800 rounded-xl p-3 shadow-sm overflow-x-auto gap-4">
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-orange-500 mb-1"></i><span>Bronze</span></div>
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-slate-400 mb-1"></i><span>Silver</span></div>
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-yellow-400 mb-1"></i><span>Gold</span></div>
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-slate-500 mb-1"></i><span>Plat</span></div>
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-cyan-400 mb-1"></i><span>Diamond</span></div>
                    <div class="flex flex-col items-center min-w-[50px]"><i class="fas fa-circle text-black dark:text-white mb-1"></i><span>Titan</span></div>
                </div>
            </div>

            <div class="w-full">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wide mb-3 pl-2">Top Contributors</h3>
                <div id="leaderboard-list" class="space-y-2 pb-6">
                    <div class="text-center text-xs text-slate-400 py-4">Loading Leaderboard...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view-section flex flex-col items-center p-6 h-full z-10 relative !bg-gray-50 !dark:bg-slate-900 hidden">
        </div>

    <div id="view-driver-select" class="view-section flex flex-col h-full z-10 p-6 bg-slate-50 dark:bg-slate-900">
        <div class="flex items-center mb-8 mt-4 shrink-0">
            <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-brand-500 transition-colors mr-4">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="text-2xl font-bold">Select Route</h2>
        </div>

        <div id="route-sub-select" class="hidden absolute inset-0 bg-white/95 dark:bg-slate-900/95 z-20 flex flex-col items-center justify-center p-6 text-center backdrop-blur-md">
            <h3 class="text-2xl font-bold mb-6">Which Direction?</h3>
            <button onclick="app.confirmRoute('To UIU')" class="w-full max-w-xs glass p-6 rounded-xl mb-4 hover:bg-brand-50 transition-colors border-l-4 border-l-green-500 text-left">
                <div class="font-bold text-lg">Going to Campus</div>
                <div class="text-xs text-slate-500">From Destination &rarr; UIU</div>
            </button>
            <button onclick="app.confirmRoute('From UIU')" class="w-full max-w-xs glass p-6 rounded-xl hover:bg-brand-50 transition-colors border-l-4 border-l-blue-500 text-left">
                <div class="font-bold text-lg">Leaving Campus</div>
                <div class="text-xs text-slate-500">UIU &rarr; To Destination</div>
            </button>
            <button onclick="document.getElementById('route-sub-select').classList.add('hidden')" class="mt-8 text-slate-400 hover:text-slate-600">Cancel</button>
        </div>

        <div class="grid grid-cols-2 gap-4 overflow-y-auto pb-4">
            <button onclick="app.selectRoute('Kuril', 'K')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-road text-3xl text-blue-500 mb-3"></i>
                <span class="font-bold">Kuril</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Notun Bazar', 'N')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-shop text-3xl text-green-500 mb-3"></i>
                <span class="font-bold">Notun Bazar</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Aftab Nagar', 'A')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-building text-3xl text-purple-500 mb-3"></i>
                <span class="font-bold">Aftab Nagar</span>
                <span class="text-xs text-slate-400 mt-1">Auto Assign</span>
            </button>
            <button onclick="app.selectRoute('Transport', 'R')" class="glass p-6 rounded-xl flex flex-col items-center justify-center hover:bg-brand-50 dark:hover:bg-slate-800 transition-all">
                <i class="fas fa-bus-alt text-3xl text-orange-500 mb-3"></i>
                <span class="font-bold">Transport</span>
                <span class="text-xs text-slate-400 mt-1">Routes 1-5...</span>
            </button>
        </div>

        <div id="selection-loader" class="hidden absolute inset-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur z-50 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="font-bold animate-pulse">Syncing & Assigning ID...</p>
        </div>
    </div>

    <div id="view-driver-dashboard" class="view-section flex flex-col h-full bg-slate-50 dark:bg-slate-900 z-10">
        <div class="absolute top-0 left-0 right-0 p-4 z-30 flex justify-between items-start pointer-events-none">
            <div class="pointer-events-auto">
                 <button onclick="app.goHome()" class="w-10 h-10 rounded-full glass bg-slate-900/50 text-white flex items-center justify-center hover:scale-110 transition-transform">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
            <div class="glass bg-slate-900/80 text-white px-4 py-2 rounded-xl text-right backdrop-blur-md">
                 <div class="flex items-center justify-end gap-2 mb-1">
                    <span id="driver-connection-dot" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span id="driver-connection-text" class="text-[10px] font-bold uppercase tracking-wider text-slate-400">Offline</span>
                </div>
                <div class="text-xs text-slate-400">ID: <span id="driver-assigned-id" class="text-brand-500 font-mono font-bold">...</span></div>
                <div id="wakelock-status" class="text-[8px] text-slate-500 mt-0.5">
                    <i class="fas fa-mobile-alt"></i> Wake Lock: <span id="wakelock-text">Off</span>
                </div>
            </div>
        </div>

        <div class="h-[60%] w-full relative z-0">
            <div id="driver-map" class="w-full h-full bg-slate-200 dark:bg-slate-800"></div>
            <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-slate-50 dark:from-slate-900 to-transparent pointer-events-none z-[400]"></div>
        </div>

        <div class="flex-grow flex flex-col items-center justify-start p-6 -mt-12 relative z-20 overflow-y-auto">
            <div class="glass w-full max-w-sm rounded-3xl p-6 shadow-xl text-center backdrop-blur-xl border border-white/20">
                <div class="flex items-center justify-between mb-6">
                      <div class="text-left">
                        <h2 id="broadcast-status-title" class="text-xl font-bold">Ready to Drive?</h2>
                        <p id="broadcast-status-desc" class="text-slate-500 text-xs">Start trip to broadcast</p>
                      </div>
                      <div id="broadcast-ring" class="w-12 h-12 rounded-full border-2 border-slate-200 dark:border-slate-600 flex items-center justify-center relative">
                        <div class="absolute inset-0 rounded-full animate-pulse-glow opacity-0 transition-opacity" id="broadcast-glow"></div>
                        <i id="broadcast-icon" class="fas fa-location-arrow text-slate-300 dark:text-slate-600 transition-colors"></i>
                    </div>
                </div>

                <button id="broadcast-btn" onclick="app.toggleBroadcast()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-500/30 transition-all active:scale-95 mb-4">
                    START TRIP
                </button>

            <div class="grid grid-cols-2 gap-3 w-full max-w-sm mt-6 px-4"> 
    <div class="glass p-3 rounded-2xl text-center flex flex-col items-center justify-center">
        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Points</p>
        <p id="live-points" class="text-2xl font-black text-brand-500 mt-1">0</p>
    </div>
    <div class="glass p-3 rounded-2xl text-center flex flex-col items-center justify-center">
        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Speed</p>
        <p id="val-speed" class="text-2xl font-bold text-slate-700 dark:text-slate-200 mt-1">0 <span class="text-xs font-normal text-slate-400">km/h</span></p>
    </div>
    <div class="glass p-3 rounded-2xl text-center flex flex-col items-center justify-center">
        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Accuracy</p>
        <p id="val-accuracy" class="text-2xl font-bold text-slate-700 dark:text-slate-200 mt-1">--</p>
    </div>
    <div class="glass p-3 rounded-2xl text-center flex flex-col items-center justify-center">
        <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Time</p>
        <p id="val-uptime" class="text-2xl font-bold text-slate-700 dark:text-slate-200 mt-1">00:00</p>
    </div>
</div>
        </div>

        <div id="trip-summary-modal" class="absolute inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
             <div class="w-32 h-32 bg-gradient-to-tr from-brand-500 to-yellow-500 rounded-full flex items-center justify-center mb-6 animate-bounce shadow-[0_0_50px_rgba(249,115,22,0.5)]">
                 <i class="fas fa-star text-6xl text-white"></i>
             </div>
             <h2 class="text-4xl font-black text-white mb-2">Congratulations!</h2>
             <p class="text-slate-400 mb-8 text-center px-4">Thanks for contributing. It means a lot for us.</p>

             <div class="glass p-8 rounded-3xl text-center max-w-xs w-full mx-6">
                 <img id="summary-photo" src="" class="w-16 h-16 rounded-full mx-auto mb-4 border-2 border-white">
                 <h3 id="summary-name" class="font-bold text-white text-lg mb-1">...</h3>
                 <div class="text-sm text-slate-400 mb-4">You have earned</div>
                 <div class="text-5xl font-black text-brand-500 mb-2 animate-pulse" id="summary-points">0</div>
                 <div class="text-xs font-bold text-brand-500 uppercase tracking-widest mb-4">Points</div>
                 <div class="border-t border-slate-700 pt-4">
                     <p class="text-xs text-slate-400">Total Points</p>
                     <p id="summary-total-points" class="text-xl font-bold text-white">0</p>
                 </div>
             </div>

             <button onclick="app.closeSummary()" class="mt-8 px-8 py-3 bg-white text-brand-600 font-bold rounded-full hover:scale-105 transition-transform">
                 Continue
             </button>
        </div>
    </div>
    </div>

    <div id="view-student" class="view-section flex flex-col h-full z-10">
        <div class="absolute top-4 left-4 right-16 z-[400]">
            <div class="glass rounded-full p-2 pl-4 pr-2 flex justify-between items-center shadow-lg">
                <div class="flex items-center gap-3">
                    <button onclick="app.goHome()" class="w-8 h-8 bg-slate-100 dark:bg-slate-700 rounded-full flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-brand-500 hover:text-white transition-colors">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div>
                        <h2 class="font-bold text-sm leading-tight">Live Map</h2>
                        <div class="flex items-center gap-2 text-[10px] text-slate-500 dark:text-slate-400">
                            <span class="flex items-center gap-1"><i class="fas fa-users"></i> <span id="count-users">0</span></span>
                            <span class="flex items-center gap-1"><i class="fas fa-bus"></i> <span id="count-buses">0</span></span>
                        </div>
                    </div>
                </div>
                <div id="student-status" class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-full text-[10px] font-bold text-slate-500 flex items-center gap-2">
                    <div class="w-2 h-2 bg-slate-400 rounded-full"></div> Connect
                </div>
            </div>
        </div>

        <div class="flex-grow relative bg-slate-200 dark:bg-slate-900 overflow-hidden">
            <div id="map" class="h-full w-full outline-none z-0"></div>
        </div>

        <div class="bg-white dark:bg-slate-900 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 relative transition-transform duration-300 transform translate-y-0" id="bottom-sheet">
            <div class="w-full flex justify-center pt-3 pb-1 cursor-pointer" onclick="app.toggleBottomSheet()">
                <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
            </div>
            <div class="p-4 pb-8 max-h-[40vh] overflow-y-auto">
                <h3 class="font-bold mb-4 text-sm text-slate-500 uppercase tracking-wide">Active Transport</h3>
                <div id="bus-list" class="space-y-2">
                    <div class="text-center py-8 text-slate-400 text-sm">
                        <i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>
                        Searching for buses...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        /** FIREBASE & CLOUDINARY CONFIG */
        const firebaseConfig = {
          apiKey: "AIzaSyAklMLhNG8INCYKh_ADQOgm2CQCAGc4hgo",
          authDomain: "uiu-bus-tracker-01.firebaseapp.com",
          projectId: "uiu-bus-tracker-01",
          storageBucket: "uiu-bus-tracker-01.firebasestorage.app",
          messagingSenderId: "576909822280",
          appId: "1:576909822280:web:29d4e8008b6c2033740b7d",
          measurementId: "G-YDZN4Q5YHF"
        };

        const CLOUDINARY_CLOUD_NAME = 'dxjtj6wan';
        const CLOUDINARY_UPLOAD_PRESET = 'standard_upload';

        // Init Firebase
        let db = null;
        try {
            const fbApp = initializeApp(firebaseConfig);
            db = getFirestore(fbApp);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        /** APP CONFIG */
        const CONFIG = {
            mqtt: {
                protocol: 'wss',
                host: '09872002dac9410e9af391b1a7066483.s1.eu.hivemq.cloud',
                port: 8884,
                path: '/mqtt',
                username: 'naimur',
                password: 'Sohan786@',
                clientId: (() => {
                    let id = localStorage.getItem('mqtt_client_id');
                    if (!id) {
                        id = 'uiu-' + Math.random().toString(16).substr(2, 8);
                        localStorage.setItem('mqtt_client_id', id);
                    }
                    return id;
                })()
            },
            topics: {
                location: 'uiu/bus/location',
                presence: 'uiu/presence'
            },
            uiuCoords: [23.79790, 90.44970], 
            presenceInterval: 15000,
            minAccuracy: 50
        };

        // COLORS updated for new requirements
        const BUS_STYLES = {
            'K': 'bg-blue-500',   // Kuril - Blue
            'N': 'bg-green-500',  // Notun Bazar - Green
            'A': 'bg-purple-500', // Aftab Nagar - Purple
            'default': 'bg-orange-500',
            'to_uiu': 'bg-green-600',
            'from_uiu': 'bg-red-600'
        };

        /** GLOBAL STATE */
        const state = {
            client: null,
            isConnected: false,
            role: null,
            driverId: null,
            driverRoute: null,
            driverDestination: null,
            isBroadcasting: false,
            watchId: null,
            wakeLock: null,
            activeBuses: {},
            activeUsers: new Map(),
            userCache: {},
            map: null,
            driverMap: null,
            driverMarker: null,
            markers: {},
            circles: {}, 
            lastSentTime: 0,
            sessionPoints: 0,
            sessionDistance: 0,
            lastLat: null,
            lastLng: null,
            tripStartTime: null, // Added for uptime
            uptimeInterval: null // Added for uptime
        };

        /** APP CONTROLLER */
        const app = {
            init: () => {
                app.loadTheme();
                app.connectMqtt();
                console.log("App Version: Final Stable");
                
                // CHECK LOCALSTORAGE
                const savedDriverId = localStorage.getItem('active_driver_id');
                const savedRoute = localStorage.getItem('active_driver_route');
                
                if (savedDriverId && savedRoute) {
                    console.log("Restoring previous session...");
                    state.driverId = savedDriverId;
                    state.driverRoute = savedRoute;
                    state.driverDestination = localStorage.getItem('active_driver_dest');
                    state.driverDirection = localStorage.getItem('active_driver_dir');
                    
                    app.setRole('driver-dashboard');
                    document.getElementById('driver-assigned-id').innerText = `${state.driverRoute} [${state.driverId}]`;
                    app.switchView('view-driver-dashboard');
                    app.initDriverMap();
                }

                setInterval(app.sendHeartbeat, CONFIG.presenceInterval);
                setInterval(app.cleanupStaleUsers, 10000);
            },

            // --- Theme & View ---
            escapeHtml: (text) => {
                if (!text) return text;
                return String(text)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            },

            toggleTheme: () => {
                const html = document.documentElement;
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                }
                app.updateMapStyle();
            },

            loadTheme: () => {
                const theme = localStorage.getItem('theme');
                if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            },

            switchView: (viewId) => {
                console.log("Switching to:", viewId);
                const views = document.querySelectorAll('.view-section');
                views.forEach(el => {
                    el.classList.remove('view-active');
                    el.style.opacity = '0';
                    el.style.pointerEvents = 'none';
                    el.style.zIndex = '0';
                });

                const target = document.getElementById(viewId);
                if (target) {
                    target.classList.add('view-active');
                    void target.offsetWidth; 
                    target.style.opacity = '1';
                    target.style.pointerEvents = 'auto';
                    target.style.zIndex = '100';
                    target.style.visibility = 'visible';
                } else {
                    console.error("View not found:", viewId);
                }

                const globalControls = document.getElementById('global-controls');
                if (globalControls) {
                    if (viewId === 'view-landing') {
                        globalControls.classList.remove('opacity-0', 'pointer-events-none', 'invisible');
                    } else {
                        globalControls.classList.add('opacity-0', 'pointer-events-none', 'invisible');
                    }
                }
            },

            setRole: (role) => {
                state.role = role;
                if (role === 'student') {
                    app.switchView('view-student');
                    app.initMap();
                } else if (role === 'driver-select') {
                    app.switchView('view-driver-select');
                }
            },

            goHome: async () => {
                try {
                    if (state.isBroadcasting) {
                        const confirmExit = confirm("Stop broadcasting and exit?");
                        if (!confirmExit) return;
                        await app.stopBroadcast();
                        if (state.sessionPoints > 0) return; 
                    }

                    state.driverId = null;
                    state.driverRoute = null;
                    state.driverDestination = null;
                    state.driverDirection = null;
                    state.role = null;

                    if (state.driverMap) {
                        state.driverMap.remove();
                        state.driverMap = null;
                    }

                    localStorage.removeItem('active_driver_id');
                    localStorage.removeItem('active_driver_route');
                    localStorage.removeItem('active_driver_dest');
                    localStorage.removeItem('active_driver_dir');
                    
                } catch (error) {
                    console.error("Error during exit:", error);
                }
                app.switchView('view-landing');
            },

            // --- Wake Lock ---
            requestWakeLock: async () => {
                if ('wakeLock' in navigator) {
                    try {
                        state.wakeLock = await navigator.wakeLock.request('screen');
                        document.getElementById('wakelock-text').innerText = "Active";
                        document.getElementById('wakelock-text').className = "text-green-500 font-bold";
                        
                        state.wakeLock.addEventListener('release', () => {
                            document.getElementById('wakelock-text').innerText = "Inactive";
                        });
                    } catch (err) {
                        console.error(`${err.name}, ${err.message}`);
                    }
                }
            },

            releaseWakeLock: () => {
                if (state.wakeLock) {
                    state.wakeLock.release();
                    state.wakeLock = null;
                }
            },

            // --- MQTT Logic ---
            connectMqtt: () => {
                console.log("Connecting to MQTT...");
                const connectUrl = `wss://${CONFIG.mqtt.host}:${CONFIG.mqtt.port}/mqtt`;
                
                state.client = mqtt.connect(connectUrl, {
                    username: CONFIG.mqtt.username,
                    password: CONFIG.mqtt.password,
                    clientId: CONFIG.mqtt.clientId,
                    clean: true
                });

                state.client.on('connect', () => {
                    console.log("MQTT Connected");
                    state.isConnected = true;
                    app.updateConnectionStatus('connected');
                    state.client.subscribe(CONFIG.topics.location);
                    state.client.subscribe(CONFIG.topics.presence);
                    app.sendHeartbeat();
                });

                state.client.on('message', (topic, message) => {
                    const msgString = message.toString();
                    if (!msgString) return;

                    try {
                        const data = JSON.parse(msgString);
                        if (topic === CONFIG.topics.location) {
                            app.handleLocationUpdate(data);
                        } else if (topic === CONFIG.topics.presence) {
                            app.handlePresenceUpdate(data);
                        }
                    } catch (e) { 
                        console.error("Msg Parse Error:", e); 
                    }
                });

                state.client.on('error', (err) => {
                    console.error("MQTT Error", err);
                    state.isConnected = false;
                    app.updateConnectionStatus('error');
                });
                
                state.client.on('close', () => {
                    state.isConnected = false;
                    app.updateConnectionStatus('offline');
                });
            },

            updateConnectionStatus: (status) => {
                const dot = document.getElementById('driver-connection-dot');
                const text = document.getElementById('driver-connection-text');
                const studentStatus = document.getElementById('student-status');

                if (status === 'connected') {
                    if (dot) dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]";
                    if (text) text.innerText = "ONLINE";
                    if (studentStatus) {
                        studentStatus.innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Live';
                        studentStatus.classList.add('text-green-600', 'bg-green-100');
                    }
                } else {
                    if (dot) dot.className = "w-2 h-2 rounded-full bg-red-500";
                    if (text) text.innerText = "OFFLINE";
                    if (studentStatus) {
                        studentStatus.innerHTML = '<div class="w-2 h-2 bg-red-400 rounded-full"></div> Connect';
                    }
                }
            },

            sendHeartbeat: () => {
                if (state.client && state.isConnected) {
                    state.client.publish(CONFIG.topics.presence, JSON.stringify({
                        id: CONFIG.mqtt.clientId,
                        ts: Date.now(),
                        role: state.role || 'viewer'
                    }));
                }
            },

            handlePresenceUpdate: (data) => {
                state.activeUsers.set(data.id, data.ts);
                app.updateUserCount();
            },

            cleanupStaleUsers: () => {
                const now = Date.now();
                // 1. Cleanup Viewers
                for (const [id, ts] of state.activeUsers) {
                    if (now - ts > 45000) state.activeUsers.delete(id);
                }
                app.updateUserCount();

                // 2. Cleanup Buses - UPDATED TO 10 SECONDS
                for (const id in state.activeBuses) {
                    if (now - state.activeBuses[id].ts > 10000) { // Changed to 10 seconds
                        delete state.activeBuses[id];
                        app.removeBusMarker(id);
                    }
                }
                app.updateBusList();
            },

            updateUserCount: () => {
                const el = document.getElementById('count-users');
                if (el) el.innerText = state.activeUsers.size;
            },

            // --- Location Logic ---
            handleLocationUpdate: (data) => {
                if (data.status === 'offline') {
                    delete state.activeBuses[data.id];
                    app.removeBusMarker(data.id);
                    app.updateBusList();
                    return;
                }

                if (state.isBroadcasting && data.id === state.driverId) return;

                const timeDiff = Date.now() - data.ts;
                if (timeDiff > 120000) return;
                
                state.activeBuses[data.id] = data;

                if (state.role === 'student') {
                    app.updateBusMarker(data);
                    app.updateBusList();
                }
            },

            selectRoute: (name, prefix) => {
                state.tempRouteName = name;
                state.tempRoutePrefix = prefix;
                document.getElementById('route-sub-select').classList.remove('hidden');
            },

            confirmRoute: (direction) => {
                const name = state.tempRouteName;
                const prefix = state.tempRoutePrefix;
                const fullRouteName = `${name} (${direction})`;

                document.getElementById('route-sub-select').classList.add('hidden');
                const loader = document.getElementById('selection-loader');
                if (loader) loader.classList.remove('hidden');

                // NEW LOGIC: Wait for Connection + Data Sync
                let attempts = 0;
                const syncInterval = setInterval(() => {
                    attempts++;

                    // Wait until:
                    // 1. MQTT is connected
                    // 2. AND we have waited at least 500ms (attempts > 5) to receive data
                    const isReady = state.isConnected && attempts > 5;
                    const isTimedOut = attempts > 50; // Force start after 5 seconds if internet is bad

                    if (isReady || isTimedOut) {
                        clearInterval(syncInterval);
                        
                        // NOW we calculate the ID, knowing we have the latest data from other drivers
                        const assignedId = app.assignNextId(prefix);
                        
                        state.driverRoute = fullRouteName;
                        state.driverId = assignedId;
                        state.driverDestination = name;
                        state.driverDirection = direction;

                        localStorage.setItem('active_driver_id', assignedId);
                        localStorage.setItem('active_driver_route', fullRouteName);
                        localStorage.setItem('active_driver_dest', name);
                        localStorage.setItem('active_driver_dir', direction);

                        document.getElementById('driver-assigned-id').innerText = fullRouteName + ' [' + assignedId + ']';
                        if (loader) loader.classList.add('hidden');
                        
                        app.switchView('view-driver-dashboard');
                        app.initDriverMap();
                    }
                }, 100); // Check every 100ms
            },

            assignNextId: (prefix) => {
                const activeIds = Object.keys(state.activeBuses)
                    .filter(id => id.startsWith(prefix))
                    .map(id => parseInt(id.replace(prefix, '')))
                    .filter(num => !isNaN(num))
                    .sort((a, b) => a - b);

                let nextNum = 1;
                for (const num of activeIds) {
                    if (num === nextNum) nextNum++;
                    else if (num > nextNum) break;
                }
                return prefix + nextNum;
            },

            // --- Gamification Logic ---
            openCaptainsDeck: async () => {
                app.switchView('view-captains-deck');
                const id = CONFIG.mqtt.clientId;
                if (!db) return;

                // Reset progress bar for animation
                document.getElementById('deck-progress').style.width = '0%';

                try {
                    const docRef = doc(db, "users", id);
                    const docSnap = await getDoc(docRef);
                    let points = 0;
                    if (docSnap.exists()) {
                        points = docSnap.data().totalPoints || 0;
                    } else {
                        document.getElementById('deck-rank').innerText = "BRONZE"; // CHANGED ROOKIE TO BRONZE
                        document.getElementById('deck-rank').className = "text-xl font-bold text-slate-400";
                    }

                    document.getElementById('deck-points').innerHTML = `${points} <span class="text-sm font-normal text-slate-500">pts</span>`;

                    let rank = "BRONZE"; // CHANGED ROOKIE TO BRONZE
                    let progress = 0;
                    let nextTier = 100;
                    let color = "from-brand-300 to-brand-500"; 

                    if (points >= 5000) {
                        rank = "TITANIUM";
                        progress = 100;
                        nextTier = 10000;
                        color = "from-slate-700 to-black";
                    } else if (points >= 2500) {
                        rank = "DIAMOND";
                        progress = ((points - 2500) / 2500) * 100;
                        nextTier = 5000;
                        color = "from-blue-400 to-cyan-300";
                    } else if (points >= 1000) {
                        rank = "PLATINUM";
                        progress = ((points - 1000) / 1500) * 100;
                        nextTier = 2500;
                        color = "from-slate-300 to-slate-400";
                    } else if (points >= 500) {
                        rank = "GOLD";
                        progress = ((points - 500) / 500) * 100;
                        nextTier = 1000;
                        color = "from-yellow-300 to-yellow-500";
                    } else if (points >= 100) {
                        rank = "SILVER";
                        progress = ((points - 100) / 400) * 100;
                        nextTier = 500;
                        color = "from-slate-300 to-slate-500";
                    } else {
                        rank = "BRONZE"; // CHANGED ROOKIE TO BRONZE
                        progress = (points / 100) * 100;
                        nextTier = 100;
                        color = "from-orange-300 to-orange-500";
                    }
                    
                    const rankEl = document.getElementById('deck-rank');
                    rankEl.innerText = rank;
                    rankEl.className = `text-2xl font-black uppercase tracking-widest text-transparent bg-clip-text bg-gradient-to-r ${color} mb-1`;

                    document.getElementById('next-tier-text').innerText = `${Math.max(0, nextTier - points)} pts to next rank`;

                    // Animate Bar
                    setTimeout(() => {
                        document.getElementById('deck-progress').style.width = `${Math.min(100, progress)}%`;
                    }, 100);

                } catch (e) {
                    console.error("Error loading stats:", e);
                }

                // Load Leaderboard
                const listEl = document.getElementById('leaderboard-list');
                listEl.innerHTML = '<div class="text-center text-xs text-slate-400 py-4"><div class="loader mx-auto mb-2"></div>Loading Leaderboard...</div>';

                try {
                    const q = query(collection(db, "users"), orderBy("totalPoints", "desc"), limit(20));
                    const querySnapshot = await getDocs(q);
                    
                    listEl.innerHTML = '';
                    
                    let count = 0;
                    let anonCount = 1;

                    querySnapshot.forEach((doc) => {
                        count++;
                        if (count > 5) return;
                        const d = doc.data();
                        const uId = doc.id;

                        let name = d.username;
                        let img = d.photoUrl;

                        if (!name) {
                            name = `Anonymous User ${anonCount++}`;
                        }
                        if (!img) {
                             img = `https://api.dicebear.com/7.x/avataaars/svg?seed=${uId}`;
                        }

                        const pts = d.totalPoints || 0;
                        const isMe = (uId === id) ? 'border-brand-500 border-2' : 'border-transparent border';

                        const row = document.createElement('div');
                        row.className = `flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-xl shadow-sm ${isMe}`;
                        row.innerHTML = `
                            <div class="font-bold text-slate-300 text-lg w-6">#${count}</div>
                            <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden">
                                <img src="${img}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-grow">
                                <div class="font-bold text-sm text-slate-700 dark:text-slate-200 truncate w-32">${app.escapeHtml(name)}</div>
                                <div class="text-[10px] text-brand-500 font-bold">${pts} pts</div>
                            </div>
                        `;
                        listEl.appendChild(row);
                    });

                    if (count === 0) {
                        listEl.innerHTML = '<div class="text-center text-xs text-slate-400 py-4">No Contributors yet. Be the first!</div>';
                    }

                } catch(e) {
                    console.error("Leaderboard error:", e);
                    listEl.innerHTML = '<div class="text-center text-xs text-red-400 py-4">Failed to load leaderboard</div>';
                }
            },

            calculateDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;

                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },

            // --- Driver Map & Routing ---
            initDriverMap: () => {
                if (state.driverMap) {
                    state.driverMap.remove();
                    state.driverMap = null;
                }

                const COORDS = {
                    'UIU': CONFIG.uiuCoords, // 23.79790, 90.44970
                    'Kuril': [23.822339, 90.420163],
                    'Notun Bazar': [23.797881, 90.424652],
                    'Aftab Nagar': [23.767860, 90.425833],
                    'Transport': CONFIG.uiuCoords 
                };

                let start, end;
                if (state.driverDirection === 'From UIU') {
                    start = COORDS['UIU'];
                    end = COORDS[state.driverDestination] || COORDS['Transport'];
                } else {
                    start = COORDS[state.driverDestination] || COORDS['Transport'];
                    end = COORDS['UIU'];
                }

                setTimeout(() => {
                    state.driverMap = L.map('driver-map', { zoomControl: false }).setView(start, 13);
                    const isDark = document.documentElement.classList.contains('dark');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OSM',
                        className: isDark ? 'dark-map-tiles' : ''
                    }).addTo(state.driverMap);

                    L.marker(start).addTo(state.driverMap).bindPopup("Start");
                    L.marker(end).addTo(state.driverMap).bindPopup("End");

                    const iconHtml = `
                        <div class="bg-blue-600 w-6 h-6 rounded-full border-2 border-white shadow-lg flex items-center justify-center relative pulse-ring">
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                    `;
                    const icon = L.divIcon({ className: '', html: iconHtml, iconSize: [24, 24] });
                    state.driverMarker = L.marker(start, {icon: icon}).addTo(state.driverMap);

                    // Jump to UIU Button
                    const jumpBtn = L.control({position: 'bottomright'});
                    jumpBtn.onAdd = function(map) {
                        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                        div.innerHTML = `<button onclick="state.driverMap.setView(CONFIG.uiuCoords, 16)" class="bg-white w-10 h-10 rounded-md flex items-center justify-center text-brand-500 font-bold shadow-md cursor-pointer hover:bg-slate-50"><i class="fas fa-university text-xl"></i></button>`;
                        return div;
                    };
                    jumpBtn.addTo(state.driverMap);
                }, 100);
            },

            // --- Driver Broadcasting ---
            toggleBroadcast: () => {
                if (state.isBroadcasting) app.stopBroadcast();
                else app.startBroadcast();
            },

            startBroadcast: () => {
                if (!navigator.geolocation) {
                    alert("Geolocation not supported");
                    return;
                }

                const checkConflictAndStart = (pos) => {
                     const myLat = pos.coords.latitude;
                    const myLng = pos.coords.longitude;
                    
                    let conflict = false;
                    const buses = Object.values(state.activeBuses);
                    
                    for (let bus of buses) {
                        if (bus.route === state.driverRoute && bus.id !== state.driverId) {
                            const dist = app.calculateDistance(myLat, myLng, bus.lat, bus.lng);
                            if (dist < 20) { // 20 Meters
                                conflict = true;
                                break;
                            }
                        }
                    }

                    if (conflict) {
                        alert("⚠️ Another Captain is tracking this bus nearby! Help preserve battery.");
                        return;
                    }

                    app.executeStartBroadcast();
                };

                navigator.geolocation.getCurrentPosition(checkConflictAndStart, (err) => {
                    alert("Please enable GPS");
                }, { enableHighAccuracy: true });
            },

            executeStartBroadcast: () => {
                state.sessionPoints = 0;
                state.sessionDistance = 0;
                state.lastLat = null;
                state.lastLng = null;
                document.getElementById('live-points').innerText = "0";

                // Start Timer
                state.tripStartTime = Date.now();
                state.uptimeInterval = setInterval(() => {
                    const diff = Math.floor((Date.now() - state.tripStartTime) / 1000);
                    const m = Math.floor(diff / 60).toString().padStart(2, '0');
                    const s = (diff % 60).toString().padStart(2, '0');
                    const el = document.getElementById('val-uptime');
                    if(el) el.innerText = `${m}:${s}`;
                }, 1000);

                state.isBroadcasting = true;
                app.updateBroadcastUI(true);
                app.requestWakeLock();

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };

                state.watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        let { latitude, longitude, accuracy, speed } = position.coords;
                        const speedKmh = (speed || 0) * 3.6;
                        document.getElementById('val-speed').innerHTML = `${Math.round(speedKmh)} <span class="text-[10px]">km/h</span>`;
                        document.getElementById('val-accuracy').innerText = Math.round(accuracy) + ' m';

                        // Gamification: Speed > 3kmh
                        if (state.lastLat && state.lastLng && speedKmh > 3) {
                            const dist = app.calculateDistance(state.lastLat, state.lastLng, latitude, longitude);
                            const pts = dist * 0.01; // 1km = 10pts
                            state.sessionPoints += pts;
                            state.sessionDistance += dist;
                            document.getElementById('live-points').innerText = Math.floor(state.sessionPoints);
                        }

                        if (state.driverMarker) {
                            state.driverMarker.setLatLng([latitude, longitude]);
                            if (state.driverMap) state.driverMap.panTo([latitude, longitude]);
                        }

                        state.lastLat = latitude;
                        state.lastLng = longitude;

                        // MQTT Publish Rate Limit (200ms)
                        const now = Date.now();
                        if (now - state.lastSentTime < 200) return;
                        state.lastSentTime = now;

                        if (state.client && state.isConnected) {
                            const payload = JSON.stringify({
                                id: state.driverId,
                                uid: CONFIG.mqtt.clientId, 
                                route: state.driverRoute,
                                lat: latitude,
                                lng: longitude,
                                acc: accuracy,
                                ts: now
                            });
                            state.client.publish(CONFIG.topics.location, payload, { retain: true });
                        }
                    },
                    (error) => {
                        console.error("GPS Error", error);
                    },
                    options
                );
            },

            stopBroadcast: async () => {
                state.isBroadcasting = false;
                app.updateBroadcastUI(false);
                app.releaseWakeLock();
                if (state.watchId) {
                    navigator.geolocation.clearWatch(state.watchId);
                    state.watchId = null;
                }

                // Stop Timer
                if (state.uptimeInterval) {
                    clearInterval(state.uptimeInterval);
                    state.uptimeInterval = null;
                }
                const uptimeEl = document.getElementById('val-uptime');
                if(uptimeEl) uptimeEl.innerText = "00:00";

                // --- FIX: Add retain: true here ---
                if (state.client && state.isConnected) {
                      state.client.publish(CONFIG.topics.location, JSON.stringify({
                        id: state.driverId,
                        status: 'offline'
                      }), { retain: true }); // <--- CRITICAL: Clears the ID from server memory
                }
                // ----------------------------------

                const finalPoints = Math.floor(state.sessionPoints);
                if (finalPoints > 0) {
                    await app.showSummary(finalPoints);
                } 
            },
            showSummary: async (points) => {
                const modal = document.getElementById('trip-summary-modal');
                const id = CONFIG.mqtt.clientId;
                let name = "Captain";
                let photo = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                let totalPoints = points;

                if (db) {
                    try {
                        const docRef = doc(db, "users", id);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            name = data.username || name;
                            photo = data.photoUrl || photo;
                            totalPoints = (data.totalPoints || 0) + points;
                            await updateDoc(docRef, { totalPoints: totalPoints });
                        } else {
                             await setDoc(docRef, { totalPoints: points, username: "", photoUrl: "" });
                        }
                    } catch (e) { console.error(e); }
                }

                document.getElementById('summary-points').innerText = points;
                document.getElementById('summary-total-points').innerText = totalPoints;
                document.getElementById('summary-name').innerText = name;
                document.getElementById('summary-photo').src = photo;
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.style.opacity = '1';
                modal.style.pointerEvents = 'auto';
            },

            closeSummary: () => {
                document.getElementById('trip-summary-modal').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('trip-summary-modal').style.opacity = '0';
                state.sessionPoints = 0; 
                app.goHome(); 
            },

            updateBroadcastUI: (isActive) => {
                const btn = document.getElementById('broadcast-btn');
                const glow = document.getElementById('broadcast-glow');
                const title = document.getElementById('broadcast-status-title');
                const icon = document.getElementById('broadcast-icon');

                if (isActive) {
                    btn.innerText = "STOP TRIP";
                    btn.classList.replace('bg-brand-500', 'bg-red-500');
                    btn.classList.replace('hover:bg-brand-600', 'hover:bg-red-600');
                    btn.classList.add('animate-pulse');
                    glow.style.opacity = '1';
                    glow.className = "absolute inset-0 rounded-full animate-pulse-glow bg-green-400";
                    title.innerText = "Broadcasting";
                    icon.classList.remove('text-slate-300', 'dark:text-slate-600');
                    icon.classList.add('text-green-500');
                } else {
                    btn.innerText = "START TRIP";
                    btn.classList.replace('bg-red-500', 'bg-brand-500');
                    btn.classList.replace('hover:bg-red-600', 'hover:bg-brand-600');
                    btn.classList.remove('animate-pulse');
                    glow.style.opacity = '0';
                    title.innerText = "Ready?";
                    icon.classList.add('text-slate-300', 'dark:text-slate-600');
                    icon.classList.remove('text-green-500');
                }
            },

            // --- Student Map ---
            initMap: () => {
                setTimeout(() => {
                    if (!state.map) {
                        state.map = L.map('map', { zoomControl: false }).setView(CONFIG.uiuCoords, 14);
                        L.control.zoom({ position: 'bottomright' }).addTo(state.map);
                        
                        // Jump to UIU Button
                        const jumpBtn = L.control({position: 'bottomright'});
                        jumpBtn.onAdd = function(map) {
                            const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                            div.innerHTML = `<button onclick="state.map.setView(CONFIG.uiuCoords, 16)" class="bg-white w-8 h-8 flex items-center justify-center text-brand-500 font-bold shadow-md cursor-pointer hover:bg-slate-50 rounded-sm mb-[2px]"><i class="fas fa-university"></i></button>`;
                            return div;
                        };
                        jumpBtn.addTo(state.map);

                        const uiuIcon = L.divIcon({
                             className: '',
                             html: '<div class="text-2xl">🎓</div>',
                             iconSize: [30, 30]
                        });
                        L.marker(CONFIG.uiuCoords, {icon: uiuIcon}).addTo(state.map).bindPopup("UIU Campus");
                        app.updateMapStyle();
                    }
                    requestAnimationFrame(() => { state.map.invalidateSize(); });
                }, 100);
            },

            createBusIcon: (id, colorClass) => {
                 // UPDATED MARKER DESIGN: Pin shape with ID inside, no Avatar
                 return L.divIcon({
                    className: 'custom-bus-pin', 
                    html: `
                        <div class="${colorClass} w-10 h-10 rounded-full flex items-center justify-center text-white font-bold border-2 border-white shadow-lg relative z-10">
                            ${id}
                            <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-3 ${colorClass} rotate-45 z-0"></div>
                        </div>
                    `,
                    iconSize: [40, 48], 
                    iconAnchor: [20, 48], 
                    popupAnchor: [0, -48]
                });
            },

            updateMapStyle: () => {
                if (!state.map) return;
                state.map.eachLayer((layer) => {
                    if (layer instanceof L.TileLayer) state.map.removeLayer(layer);
                });
                const isDark = document.documentElement.classList.contains('dark');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OSM',
                    className: isDark ? 'dark-map-tiles' : ''
                }).addTo(state.map);
            },

            updateBusMarker: async (data) => {
                const { id, lat, lng, acc } = data;

                let colorClass = BUS_STYLES.default;
                
                // Specific Color Logic
                if (id.startsWith('K')) colorClass = BUS_STYLES['K']; // Kuril Blue
                else if (id.startsWith('N')) colorClass = BUS_STYLES['N']; // Notun Bazar Green
                else if (id.startsWith('A')) colorClass = BUS_STYLES['A']; // Aftab Nagar Purple
                else if (data.route && data.route.includes('To UIU')) colorClass = BUS_STYLES.to_uiu;
                else if (data.route && data.route.includes('From UIU')) colorClass = BUS_STYLES.from_uiu;

                if (state.markers[id]) {
                    state.markers[id].setLatLng([lat, lng]);
                    const icon = app.createBusIcon(id, colorClass); // Only pass ID and Color
                    state.markers[id].setIcon(icon);
                } else {
                    const icon = app.createBusIcon(id, colorClass);
                    const marker = L.marker([lat, lng], { icon: icon }).addTo(state.map);
                    
                    const popupContent = document.createElement('div');
                    popupContent.innerHTML = `
                        <div class="text-center p-2">
                            <b class="text-brand-500 block mb-1">Bus ${app.escapeHtml(id)}</b>
                            <p class="text-xs text-slate-500">${app.escapeHtml(data.route)}</p>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    state.markers[id] = marker;
                    app.updateBusCount();
                }

                if (acc && acc > 10) {
                    if (state.circles[id]) {
                        state.circles[id].setLatLng([lat, lng]);
                        state.circles[id].setRadius(acc);
                    } else {
                        state.circles[id] = L.circle([lat, lng], {
                            radius: acc,
                            color: 'transparent',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.2
                        }).addTo(state.map);
                    }
                }
            },

            removeBusMarker: (id) => {
                if (state.markers[id]) {
                    state.map.removeLayer(state.markers[id]);
                    delete state.markers[id];
                }
                if (state.circles[id]) {
                    state.map.removeLayer(state.circles[id]);
                    delete state.circles[id];
                }
                app.updateBusCount();
            },

            updateBusCount: () => {
                document.getElementById('count-buses').innerText = Object.keys(state.markers).length;
            },

            updateBusList: () => {
                const list = document.getElementById('bus-list');
                const buses = Object.values(state.activeBuses);
                if (buses.length === 0) {
                    if (!list.querySelector('.fa-satellite-dish')) {
                        list.innerHTML = `<div class="text-center py-8 text-slate-400 text-sm"><i class="fas fa-satellite-dish animate-pulse mb-2 block text-2xl"></i>Searching for buses...</div>`;
                    }
                    return;
                }
                
                const loader = list.querySelector('.fa-satellite-dish');
                if (loader) loader.parentElement.remove();

                buses.forEach(bus => {
                    let item = document.getElementById(`bus-${bus.id}`);
                    if (!item) {
                        item = document.createElement('div');
                        item.id = `bus-${bus.id}`;
                        item.className = "flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-xl cursor-pointer hover:bg-orange-50 dark:hover:bg-slate-700 transition-colors";
                        item.onclick = () => app.focusBus(bus.id);
                        
                        // Icon Color for List
                        let bgClass = "bg-orange-500";
                        if (bus.id.startsWith('K')) bgClass = "bg-blue-500";
                        if (bus.id.startsWith('N')) bgClass = "bg-green-500";
                        if (bus.id.startsWith('A')) bgClass = "bg-purple-500";

                        item.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full ${bgClass} text-white flex items-center justify-center font-bold">
                                    ${app.escapeHtml(bus.id)}
                                </div>
                                <div>
                                    <p class="font-bold text-sm text-slate-700 dark:text-slate-200">${app.escapeHtml(bus.route || 'Unknown')}</p>
                                    <p class="text-[10px] text-green-500 transition-opacity duration-200">Active Now</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-slate-300"></i>
                        `;
                        list.appendChild(item);
                    }
                });

                Array.from(list.children).forEach(child => {
                    if (child.id.startsWith('bus-') && !state.activeBuses[child.id.replace('bus-', '')]) {
                        child.remove();
                    }
                });
            },

            focusBus: (id) => {
                if (state.markers[id]) {
                    state.map.setView(state.markers[id].getLatLng(), 16);
                    state.markers[id].openPopup();
                    app.toggleBottomSheet();
                }
            },

            toggleBottomSheet: () => {
                const sheet = document.getElementById('bottom-sheet');
                if (sheet.classList.contains('translate-y-0')) {
                    sheet.classList.remove('translate-y-0');
                    sheet.classList.add('translate-y-[80%]');
                } else {
                    sheet.classList.remove('translate-y-[80%]');
                    sheet.classList.add('translate-y-0');
                }
            },
        };

        window.app = app;
        window.state = state;
        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
